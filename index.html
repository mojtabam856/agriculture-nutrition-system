<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="سیستم جامع مدیریت تغذیه گیاهان - توسعه‌دهنده: مجتبی فروغی">
    <meta name="author" content="مجتبی فروغی - 09133343583">
    <meta name="keywords" content="تغذیه گیاهان, کشاورزی, محاسبه کود, مدیریت تغذیه">
    <title>سیستم جامع مدیریت تغذیه گیاهان | SRS-Sepanta</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ==================== استایل‌های پایه ==================== */
        :root {
            --primary-color: #1a5f23;
            --primary-light: #2e8b32;
            --primary-dark: #0d4513;
            --secondary-color: #1565C0;
            --accent-color: #FF9800;
            --error-color: #C62828;
            --warning-color: #F57C00;
            --success-color: #388E3C;
            --info-color: #0288D1;
            --background-color: #F5F7FA;
            --card-color: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #546E7A;
            --border-color: #E0E0E0;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ==================== صفحه احراز هویت ==================== */
        #auth-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }

        .auth-container {
            width: 100%;
            max-width: 1000px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            display: flex;
            min-height: 650px;
        }

        .auth-welcome {
            flex: 1;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-color) 100%);
            color: white;
            padding: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .developer-badge {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-form-container {
            width: 450px;
            padding: 50px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 40px;
            border-bottom: 2px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .auth-tab.active {
            color: var(--primary-color);
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
        }

        .auth-content {
            display: none;
        }

        .auth-content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        /* ==================== برنامه اصلی ==================== */
        #main-app {
            display: none;
        }

        .app-header {
            background: white;
            box-shadow: var(--box-shadow);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-content {
            flex: 1;
            min-width: 300px;
        }

        .developer-header-info {
            font-size: 13px;
            color: var(--text-secondary);
            opacity: 0.8;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .app-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background: white;
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .nav-btn {
            padding: 12px 24px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border-color: var(--primary-color);
        }

        .app-content {
            min-height: 600px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        /* ==================== کارت‌ها ==================== */
        .card {
            background: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .card-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* ==================== فرم‌ها ==================== */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
            background: white;
            font-family: 'Vazirmatn', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(26, 95, 35, 0.1);
        }

        .form-control:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
        }

        /* ==================== دکمه‌ها ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            font-family: 'Vazirmatn', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 95, 35, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #0D47A1;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #2E7D32;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background: #B71C1C;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ==================== هشدارها ==================== */
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #E8F5E9;
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert-error {
            background: #FFEBEE;
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .alert-warning {
            background: #FFF8E1;
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .alert-info {
            background: #E3F2FD;
            border-color: var(--info-color);
            color: var(--info-color);
        }

        /* ==================== جدول‌ها ==================== */
        .table-responsive {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin: 20px 0;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            padding: 18px 20px;
            font-size: 15px;
            text-align: right;
        }

        .table td {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            font-size: 15px;
        }

        .table tbody tr:hover {
            background: #F9F9F9;
        }

        /* ==================== مودال ==================== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--background-color);
            color: var(--error-color);
        }

        .modal-body {
            padding: 25px;
        }

        /* ==================== داشبورد ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid var(--border-color);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-hover);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .stat-content {
            flex: 1;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ==================== برنامه‌ریز ==================== */
        .planner-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .planner-tab {
            padding: 15px 30px;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .planner-tab:hover {
            color: var(--primary-color);
        }

        .planner-tab.active {
            color: var(--primary-color);
        }

        .planner-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        .planner-content {
            display: none;
        }

        .planner-content.active {
            display: block;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        /* ==================== گزارش A4 ==================== */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .a4-report, .a4-report * {
                visibility: visible;
            }
            
            .a4-report {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                min-height: 297mm;
                padding: 20mm;
                margin: 0;
                background: white;
                box-shadow: none;
                font-size: 12pt;
            }
            
            .no-print {
                display: none !important;
            }
        }

        .a4-report {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 20mm;
            margin: 20px auto;
            box-shadow: var(--box-shadow);
            border: 1px solid #ddd;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        .report-title {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .report-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .report-body {
            margin: 30px 0;
        }

        .report-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        /* ==================== مدیریت دسترسی ==================== */
        .permission-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .permission-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .permission-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .permission-item:last-child {
            border-bottom: none;
        }

        /* ==================== پایین صفحه (فوتر) ==================== */
        .app-footer {
            margin-top: 50px;
            padding: 30px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            color: var(--text-secondary);
            border-top: 3px solid var(--primary-color);
        }

        .footer-developer {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            display: inline-block;
        }

        /* ==================== پاسخگویی ==================== */
        @media (max-width: 992px) {
            .auth-container {
                flex-direction: column;
            }
            
            .auth-welcome {
                padding: 30px;
            }
            
            .auth-form-container {
                width: 100%;
                padding: 30px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .a4-report {
                width: 100%;
                padding: 10mm;
            }
            
            .app-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .header-actions {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .planner-tabs {
                flex-direction: column;
            }
            
            .planner-tab {
                padding: 12px 20px;
                text-align: right;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .table-responsive {
                font-size: 14px;
            }
            
            .table th,
            .table td {
                padding: 12px 15px;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .nav-btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .auth-container {
                border-radius: 0;
            }
            
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        /* ==================== انیمیشن‌ها ==================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ==================== استایل‌های کمکی ==================== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-left {
            text-align: left;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mr-10 {
            margin-left: 10px;
        }

        .ml-10 {
            margin-right: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success-color);
            color: white;
        }

        .badge-warning {
            background: var(--warning-color);
            color: white;
        }

        .badge-danger {
            background: var(--error-color);
            color: white;
        }

        .badge-info {
            background: var(--info-color);
            color: white;
        }

        /* ==================== اسکرول‌بار ==================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ==================== لودر ==================== */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- صفحه احراز هویت -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-welcome">
                <h1 style="font-size: 36px; margin-bottom: 20px;">سیستم جامع مدیریت تغذیه گیاهان</h1>
                <p style="font-size: 18px; opacity: 0.9; line-height: 1.8; margin-bottom: 30px;">
                    سیستم پیشرفته محاسبه نیازهای غذایی گیاهان بر اساس استانداردهای بین‌المللی و ملی
                </p>
                <div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>محاسبات علمی دقیق</h3>
                            <p style="opacity: 0.8;">بر اساس استانداردهای FAO و مؤسسه تحقیقات خاک و آب ایران</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>مدیریت کامل فرمول‌ها</h3>
                            <p style="opacity: 0.8;">تنظیم و شخصی‌سازی تمام پارامترهای محاسباتی</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>گزارش‌های حرفه‌ای</h3>
                            <p style="opacity: 0.8;">خروجی A4 با قابلیت چاپ و ذخیره</p>
                        </div>
                    </div>
                </div>
                <div class="developer-badge">
                    <p style="font-size: 14px; margin-bottom: 5px; opacity: 0.9;">توسعه و پشتیبانی:</p>
                    <p style="font-size: 16px; font-weight: bold;">مجتبی فروغی</p>
                    <p style="font-size: 14px; margin-top: 5px; opacity: 0.9;">تلفن: 09133343583</p>
                </div>
            </div>
            
            <div class="auth-form-container">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">ورود به سیستم</button>
                    <button class="auth-tab" data-tab="register">ثبت‌نام</button>
                </div>
                
                <!-- فرم ورود -->
                <div id="login-form" class="auth-content active">
                    <div id="login-alert" class="alert" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user ml-10"></i>
                            نام کاربری
                        </label>
                        <input type="text" id="login-username" class="form-control" placeholder="نام کاربری خود را وارد کنید" autocomplete="username">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-lock ml-10"></i>
                            رمز عبور
                        </label>
                        <input type="password" id="login-password" class="form-control" placeholder="رمز عبور خود را وارد کنید" autocomplete="current-password">
                    </div>
                    
                    <button id="login-btn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                    </button>
                </div>
                
                <!-- فرم ثبت‌نام -->
                <div id="register-form" class="auth-content">
                    <div id="register-alert" class="alert" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label class="form-label">نام کامل</label>
                        <input type="text" id="register-fullname" class="form-control" placeholder="نام و نام خانوادگی">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نام کاربری</label>
                        <input type="text" id="register-username" class="form-control" placeholder="حداقل 4 کاراکتر">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ایمیل</label>
                        <input type="email" id="register-email" class="form-control" placeholder="example@domain.com">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">رمز عبور</label>
                        <input type="password" id="register-password" class="form-control" placeholder="حداقل 8 کاراکتر">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تکرار رمز عبور</label>
                        <input type="password" id="register-confirm-password" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نوع درخواست</label>
                        <select id="register-type" class="form-control" disabled>
                            <option value="user">کاربر عادی</option>
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            تغییر دسترسی فقط توسط مدیر سیستم امکان‌پذیر است
                        </small>
                    </div>
                    
                    <button id="register-btn" class="btn btn-success" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-user-plus"></i> ثبت‌نام در سیستم
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- برنامه اصلی -->
    <div id="main-app" class="container">
        <!-- هدر -->
        <div class="app-header">
            <div class="header-content">
                <h1 style="color: var(--primary-color); margin-bottom: 5px;">سیستم جامع مدیریت تغذیه گیاهان</h1>
                <p style="color: var(--text-secondary);" id="user-info">خوش آمدید</p>
                <div class="developer-header-info">
                    <i class="fas fa-code"></i>
                    توسعه‌دهنده: مجتبی فروغی - 09133343583
                </div>
            </div>
            <div class="header-actions">
                <button id="print-btn" class="btn btn-secondary no-print">
                    <i class="fas fa-print"></i> چاپ
                </button>
                <button id="logout-btn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
        
        <!-- ناوبری -->
        <div class="app-nav">
            <button class="nav-btn active" data-screen="dashboard">
                <i class="fas fa-home"></i> داشبورد
            </button>
            <button class="nav-btn" data-screen="planner">
                <i class="fas fa-calculator"></i> برنامه‌ریز تغذیه
            </button>
            <button class="nav-btn" data-screen="reports">
                <i class="fas fa-chart-bar"></i> گزارش‌ها
            </button>
            <button class="nav-btn" data-screen="history">
                <i class="fas fa-history"></i> تاریخچه
            </button>
            <button class="nav-btn admin-only" data-screen="users" style="display: none;">
                <i class="fas fa-users-cog"></i> مدیریت کاربران
            </button>
            <button class="nav-btn admin-only" data-screen="prices" style="display: none;">
                <i class="fas fa-money-bill-wave"></i> مدیریت قیمت‌ها
            </button>
            <button class="nav-btn admin-only" data-screen="formulas" style="display: none;">
                <i class="fas fa-flask"></i> فرمول‌های محاسباتی
            </button>
            <button class="nav-btn admin-only" data-screen="access" style="display: none;">
                <i class="fas fa-shield-alt"></i> مدیریت دسترسی‌ها
            </button>
            <button class="nav-btn" data-screen="profile">
                <i class="fas fa-user"></i> پروفایل
            </button>
        </div>
        
        <!-- محتوای برنامه -->
        <div class="app-content">
            <!-- داشبورد -->
            <div id="dashboard-screen" class="screen active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">کاربران فعال</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--secondary-color), #2196F3);">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-calculations">0</div>
                            <div class="stat-label">محاسبات انجام شده</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #4CAF50);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-savings">0 ریال</div>
                            <div class="stat-label">صرفه‌جویی مالی</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-color), #FFB74D);">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="active-crops">7</div>
                            <div class="stat-label">محصولات پشتیبانی شده</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3>آخرین محاسبات</h3>
                            <button class="btn btn-sm btn-secondary" onclick="system.showScreen('history')">مشاهده همه</button>
                        </div>
                        <div id="recent-calculations" style="min-height: 200px;"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>کاربران جدید</h3>
                            <button class="btn btn-sm btn-secondary admin-only" onclick="system.showScreen('users')" style="display: none;">مشاهده همه</button>
                        </div>
                        <div id="recent-users" style="min-height: 200px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- برنامه‌ریز تغذیه -->
            <div id="planner-screen" class="screen">
                <div class="card">
                    <h2 class="card-title">برنامه‌ریز تغذیه گیاهان</h2>
                    <p class="card-subtitle">لطفا اطلاعات مورد نیاز را برای محاسبه نیازهای غذایی گیاه وارد کنید</p>
                    
                    <div class="planner-tabs">
                        <button class="planner-tab active" data-tab="crop-info">اطلاعات محصول</button>
                        <button class="planner-tab" data-tab="soil-analysis">آنالیز خاک</button>
                        <button class="planner-tab" data-tab="water-analysis">آنالیز آب</button>
                        <button class="planner-tab" data-tab="results">نتایج</button>
                    </div>
                    
                    <!-- تب اطلاعات محصول -->
                    <div id="crop-info-tab" class="planner-content active">
                        <div class="input-grid">
                            <div class="form-group">
                                <label class="form-label">انتخاب محصول</label>
                                <select id="crop-selection" class="form-control">
                                    <option value="wheat">گندم</option>
                                    <option value="rice">برنج</option>
                                    <option value="saffron">زعفران</option>
                                    <option value="cucumber">خیار</option>
                                    <option value="tomato">گوجه فرنگی</option>
                                    <option value="corn">ذرت</option>
                                    <option value="potato">سیب زمینی</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">منطقه کشت</label>
                                <select id="region-selection" class="form-control">
                                    <option value="north">شمال (خزر)</option>
                                    <option value="central">مرکزی</option>
                                    <option value="south">جنوب</option>
                                    <option value="east">شرق</option>
                                    <option value="west">غرب</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">مرحله رشد</label>
                                <select id="growth-stage" class="form-control">
                                    <option value="initial">مرحله ابتدایی</option>
                                    <option value="vegetative">رشد رویشی</option>
                                    <option value="reproductive">تولید مثل</option>
                                    <option value="ripening">رسیدگی</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">مساحت تحت کشت (هکتار)</label>
                                <input type="number" id="cultivation-area" class="form-control" value="1" min="0.1" step="0.1">
                            </div>
                        </div>
                        
                        <div style="text-align: left; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="system.nextPlannerTab('soil-analysis')">
                                مرحله بعد <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- تب آنالیز خاک -->
                    <div id="soil-analysis-tab" class="planner-content">
                        <p class="card-subtitle">لطفا مقادیر آنالیز خاک را وارد کنید (mg/kg)</p>
                        
                        <div class="input-grid" id="soil-inputs">
                            <!-- توسط جاوااسکریپت تولید می‌شود -->
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="system.nextPlannerTab('crop-info')">
                                <i class="fas fa-arrow-right"></i> مرحله قبل
                            </button>
                            <button class="btn btn-primary" onclick="system.nextPlannerTab('water-analysis')">
                                مرحله بعد <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- تب آنالیز آب -->
                    <div id="water-analysis-tab" class="planner-content">
                        <p class="card-subtitle">لطفا مقادیر آنالیز آب را وارد کنید</p>
                        
                        <div class="input-grid" id="water-inputs">
                            <!-- توسط جاوااسکریپت تولید می‌شود -->
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="system.nextPlannerTab('soil-analysis')">
                                <i class="fas fa-arrow-right"></i> مرحله قبل
                            </button>
                            <button class="btn btn-success" id="calculate-btn">
                                <i class="fas fa-calculator"></i> محاسبه نتایج
                            </button>
                        </div>
                    </div>
                    
                    <!-- تب نتایج -->
                    <div id="results-tab" class="planner-content">
                        <div id="calculation-summary"></div>
                        
                        <div class="alert alert-info" style="margin: 20px 0;">
                            <i class="fas fa-info-circle"></i>
                            نتایج بر اساس استانداردهای FAO و مؤسسه تحقیقات خاک و آب ایران محاسبه شده است.
                        </div>
                        
                        <div id="results-container" class="input-grid"></div>
                        
                        <div style="background: linear-gradient(135deg, var(--success-color), #66BB6A); color: white; border-radius: var(--border-radius); padding: 30px; margin: 30px 0; text-align: center;">
                            <div style="font-size: 18px; margin-bottom: 10px;">هزینه کل مورد نیاز</div>
                            <div style="font-size: 42px; font-weight: 800;" id="total-cost">0 ریال</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-top: 10px;">برای کل مساحت تحت کشت</div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
                            <button class="btn btn-secondary" onclick="system.nextPlannerTab('water-analysis')">
                                <i class="fas fa-arrow-right"></i> مرحله قبل
                            </button>
                            <div>
                                <button class="btn btn-success" id="save-report-btn">
                                    <i class="fas fa-save"></i> ذخیره گزارش
                                </button>
                                <button class="btn btn-secondary" id="print-report-btn" style="margin-right: 10px;">
                                    <i class="fas fa-print"></i> چاپ گزارش
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- گزارش‌ها -->
            <div id="reports-screen" class="screen">
                <div class="card">
                    <h2 class="card-title">گزارش‌های سیستم</h2>
                    <p class="card-subtitle">مدیریت و مشاهده گزارش‌های تولید شده</p>
                    
                    <div class="planner-tabs">
                        <button class="planner-tab active" data-report-tab="my-reports">گزارش‌های من</button>
                        <button class="planner-tab admin-only" data-report-tab="all" style="display: none;">همه گزارش‌ها</button>
                        <button class="planner-tab admin-only" data-report-tab="monthly" style="display: none;">ماهانه</button>
                    </div>
                    
                    <div id="reports-container" style="padding: 20px; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <p>گزارشی برای نمایش وجود ندارد</p>
                        <p style="margin-top: 10px; font-size: 14px;">برای ایجاد گزارش، ابتدا محاسبه‌ای انجام دهید</p>
                    </div>
                </div>
            </div>
            
            <!-- تاریخچه -->
            <div id="history-screen" class="screen">
                <div class="card">
                    <h2 class="card-title">تاریخچه محاسبات</h2>
                    <p class="card-subtitle">مدیریت و مشاهده محاسبات قبلی</p>
                    
                    <div class="input-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 25px;">
                        <div class="form-group">
                            <input type="text" id="history-search" class="form-control" placeholder="جستجو در تاریخچه...">
                        </div>
                        <div class="form-group">
                            <select id="history-filter" class="form-control">
                                <option value="all">همه موارد</option>
                                <option value="my-history">محاسبات من</option>
                                <option value="last-week">هفته گذشته</option>
                                <option value="last-month">ماه گذشته</option>
                                <option value="last-year">سال گذشته</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>تاریخ</th>
                                    <th>محصول</th>
                                    <th>منطقه</th>
                                    <th>مساحت</th>
                                    <th>هزینه کل</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- توسط جاوااسکریپت تولید می‌شود -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="history-pagination" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 30px;">
                        <button id="prev-page" class="btn btn-secondary" onclick="system.prevPage()" disabled>
                            <i class="fas fa-arrow-right"></i> قبلی
                        </button>
                        <span id="page-info">صفحه 1 از 1</span>
                        <button id="next-page" class="btn btn-secondary" onclick="system.nextPage()" disabled>
                            بعدی <i class="fas fa-arrow-left"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- مدیریت کاربران -->
            <div id="users-screen" class="screen">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">مدیریت کاربران</h2>
                        <button class="btn btn-primary" id="add-user-btn">
                            <i class="fas fa-user-plus"></i> افزودن کاربر جدید
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>نام کاربری</th>
                                    <th>نام کامل</th>
                                    <th>نقش</th>
                                    <th>وضعیت</th>
                                    <th>تاریخ انقضا</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <!-- توسط جاوااسکریپت تولید می‌شود -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- مدیریت قیمت‌ها -->
            <div id="prices-screen" class="screen">
                <div class="card">
                    <h2 class="card-title">مدیریت قیمت عناصر غذایی</h2>
                    <p class="card-subtitle">تغییر و به‌روزرسانی قیمت مواد غذایی مورد استفاده در محاسبات</p>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>عنصر</th>
                                    <th>نماد</th>
                                    <th>قیمت فعلی (ریال)</th>
                                    <th>قیمت جدید</th>
                                    <th>آخرین تغییر</th>
                                    <th>عملیات</th>
                                </tr>
                            </thead>
                            <tbody id="prices-table">
                                <!-- توسط جاوااسکریپت تولید می‌شود -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="price-history" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--border-color);">
                        <h3>تاریخچه تغییرات قیمت</h3>
                        <div id="price-history-list" style="margin-top: 20px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- فرمول‌های محاسباتی -->
            <div id="formulas-screen" class="screen">
                <div class="formulas-section">
                    <h2 class="card-title">مدیریت فرمول‌های محاسباتی</h2>
                    <p class="card-subtitle">تنظیم و ویرایش فرمول‌ها و پارامترهای محاسباتی سیستم</p>
                    
                    <div class="formula-category">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                            <i class="fas fa-calculator"></i> فرمول‌های محاسبه عناصر اصلی
                        </h3>
                        
                        <!-- فرمول نیتروژن -->
                        <div class="formula-item">
                            <div class="formula-title">
                                <i class="fas fa-atom"></i> فرمول محاسبه نیاز نیتروژن (N)
                            </div>
                            <div class="formula-code">
                                نیاز نیتروژن (kg/ha) = ((نیاز پایه گیاه × ضریب منطقه × ضریب مرحله رشد) - نیتروژن خاک) ÷ راندمان جذب
                            </div>
                            <div class="formula-params">
                                <div class="param-item">
                                    <span>نیاز پایه گیاه:</span>
                                    <input type="number" id="formula-n-base" class="form-control" style="width: 100px; display: inline-block;" value="70">
                                </div>
                                <div class="param-item">
                                    <span>ضریب منطقه (مرکزی):</span>
                                    <input type="number" id="formula-n-region" class="form-control" style="width: 100px; display: inline-block;" value="1.0" step="0.1">
                                </div>
                                <div class="param-item">
                                    <span>راندمان جذب (%):</span>
                                    <input type="number" id="formula-n-efficiency" class="form-control" style="width: 100px; display: inline-block;" value="65" step="0.1">
                                </div>
                                <div class="param-item">
                                    <span>ضریب آبشویی:</span>
                                    <input type="number" id="formula-n-leaching" class="form-control" style="width: 100px; display: inline-block;" value="0.15" step="0.01">
                                </div>
                                <button class="btn btn-sm btn-success" onclick="system.saveFormula('nitrogen')" style="margin-top: 10px;">
                                    <i class="fas fa-save"></i> ذخیره تنظیمات
                                </button>
                            </div>
                        </div>
                        
                        <!-- فرمول فسفر -->
                        <div class="formula-item">
                            <div class="formula-title">
                                <i class="fas fa-atom"></i> فرمول محاسبه نیاز فسفر (P₂O₅)
                            </div>
                            <div class="formula-code">
                                نیاز فسفر (kg/ha) = ((نیاز پایه × ضریب pH خاک × ضریب ماده آلی) - فسفر خاک) ÷ راندمان جذب
                            </div>
                            <div class="formula-params">
                                <div class="param-item">
                                    <span>نیاز پایه گیاه:</span>
                                    <input type="number" id="formula-p-base" class="form-control" style="width: 100px; display: inline-block;" value="45">
                                </div>
                                <div class="param-item">
                                    <span>ضریب pH (خنثی):</span>
                                    <input type="number" id="formula-p-ph" class="form-control" style="width: 100px; display: inline-block;" value="1.0" step="0.1">
                                </div>
                                <div class="param-item">
                                    <span>راندمان جذب (%):</span>
                                    <input type="number" id="formula-p-efficiency" class="form-control" style="width: 100px; display: inline-block;" value="25" step="0.1">
                                </div>
                                <div class="param-item">
                                    <span>ضریب ماده آلی:</span>
                                    <input type="number" id="formula-p-organic" class="form-control" style="width: 100px; display: inline-block;" value="1.0" step="0.1">
                                </div>
                                <button class="btn btn-sm btn-success" onclick="system.saveFormula('phosphorus')" style="margin-top: 10px;">
                                    <i class="fas fa-save"></i> ذخیره تنظیمات
                                </button>
                            </div>
                        </div>
                        
                        <!-- فرمول پتاسیم -->
                        <div class="formula-item">
                            <div class="formula-title">
                                <i class="fas fa-atom"></i> فرمول محاسبه نیاز پتاسیم (K₂O)
                            </div>
                            <div class="formula-code">
                                نیاز پتاسیم (kg/ha) = ((نیاز پایه × ضریب بافت خاک × ضریب رطوبت) - پتاسیم خاک) ÷ راندمان جذب
                            </div>
                            <div class="formula-params">
                                <div class="param-item">
                                    <span>نیاز پایه گیاه:</span>
                                    <input type="number" id="formula-k-base" class="form-control" style="width: 100px; display: inline-block;" value="80">
                                </div>
                                <div class="param-item">
                                    <span>ضریب بافت خاک (لومی):</span>
                                    <input type="number" id="formula-k-texture" class="form-control" style="width: 100px; display: inline-block;" value="1.0" step="0.1">
                                </div>
                                <div class="param-item">
                                    <span>راندمان جذب (%):</span>
                                    <input type="number" id="formula-k-efficiency" class="form-control" style="width: 100px; display: inline-block;" value="70" step="0.1">
                                </div>
                                <div class="param-item">
                                    <span>ضریب رطوبت:</span>
                                    <input type="number" id="formula-k-moisture" class="form-control" style="width: 100px; display: inline-block;" value="1.0" step="0.1">
                                </div>
                                <button class="btn btn-sm btn-success" onclick="system.saveFormula('potassium')" style="margin-top: 10px;">
                                    <i class="fas fa-save"></i> ذخیره تنظیمات
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- دسته‌بندی ضرایب -->
                    <div class="formula-category">
                        <h3 style="color: var(--primary-color); margin-bottom: 20px;">
                            <i class="fas fa-sliders-h"></i> ضرایب و پارامترهای منطقه‌ای
                        </h3>
                        
                        <div class="input-grid">
                            <div class="form-group">
                                <label class="form-label">ضریب منطقه شمالی (خزر)</label>
                                <input type="number" id="factor-north" class="form-control" value="1.1" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب منطقه مرکزی</label>
                                <input type="number" id="factor-central" class="form-control" value="1.0" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب منطقه جنوبی</label>
                                <input type="number" id="factor-south" class="form-control" value="0.9" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب منطقه شرقی</label>
                                <input type="number" id="factor-east" class="form-control" value="0.95" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب منطقه غربی</label>
                                <input type="number" id="factor-west" class="form-control" value="1.05" step="0.05">
                            </div>
                        </div>
                        
                        <div class="input-grid">
                            <div class="form-group">
                                <label class="form-label">ضریب مرحله ابتدایی رشد</label>
                                <input type="number" id="factor-initial" class="form-control" value="1.0" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب مرحله رویشی</label>
                                <input type="number" id="factor-vegetative" class="form-control" value="1.2" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب مرحله تولید مثل</label>
                                <input type="number" id="factor-reproductive" class="form-control" value="1.5" step="0.05">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">ضریب مرحله رسیدگی</label>
                                <input type="number" id="factor-ripening" class="form-control" value="0.8" step="0.05">
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="system.saveAllFactors()" style="margin-top: 20px;">
                            <i class="fas fa-save"></i> ذخیره همه ضرایب
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- مدیریت دسترسی‌ها -->
            <div id="access-screen" class="screen">
                <div class="card">
                    <h2 class="card-title">مدیریت دسترسی‌ها</h2>
                    <p class="card-subtitle">تعیین دسترسی کاربران به محصولات، بخش‌ها و گزارش‌های سیستم</p>
                    
                    <div class="form-group">
                        <label class="form-label">انتخاب کاربر</label>
                        <select id="user-select" class="form-control">
                            <option value="">یک کاربر انتخاب کنید</option>
                        </select>
                    </div>
                    
                    <div id="access-controls">
                        <!-- توسط جاوااسکریپت تولید می‌شود -->
                    </div>
                </div>
            </div>
            
            <!-- پروفایل -->
            <div id="profile-screen" class="screen">
                <div class="card">
                    <h2 class="card-title">پروفایل کاربری</h2>
                    <p class="card-subtitle">مشاهده و ویرایش اطلاعات حساب کاربری</p>
                    
                    <div class="input-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label class="form-label">نام کامل</label>
                            <input type="text" id="profile-fullname" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">نام کاربری</label>
                            <input type="text" id="profile-username" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ایمیل</label>
                            <input type="email" id="profile-email" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">شماره تلفن</label>
                            <input type="tel" id="profile-phone" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">نقش</label>
                            <input type="text" id="profile-role" class="form-control" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">تاریخ انقضای حساب</label>
                            <input type="text" id="profile-expiry" class="form-control" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تغییر رمز عبور</label>
                        <input type="password" id="new-password" class="form-control" placeholder="رمز عبور جدید">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تکرار رمز عبور</label>
                        <input type="password" id="confirm-new-password" class="form-control" placeholder="تکرار رمز عبور جدید">
                    </div>
                    
                    <div style="text-align: left; margin-top: 30px;">
                        <button class="btn btn-primary" id="save-profile-btn">
                            <i class="fas fa-save"></i> ذخیره تغییرات
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- فوتر -->
        <div class="app-footer">
            <p>© 2024 سیستم جامع مدیریت تغذیه گیاهان - تمامی حقوق محفوظ است</p>
            <div class="footer-developer">
                <p><strong>توسعه و پشتیبانی:</strong> مجتبی فروغی</p>
                <p><strong>تماس:</strong> 09133343583</p>
                <p><strong>وب‌سایت:</strong> srs-sepanta.ir</p>
            </div>
        </div>
    </div>

    <!-- مودال مدیریت کاربر -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">مدیریت کاربر</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="user-modal-alert" class="alert" style="display: none;"></div>
                
                <div class="input-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">نام کاربری</label>
                        <input type="text" id="modal-username" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نام کامل</label>
                        <input type="text" id="modal-fullname" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ایمیل</label>
                        <input type="email" id="modal-email" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">شماره تلفن</label>
                        <input type="tel" id="modal-phone" class="form-control">
                    </div>
                </div>
                
                <div class="input-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="form-group">
                        <label class="form-label">رمز عبور</label>
                        <input type="password" id="modal-password" class="form-control" placeholder="در صورت نیاز به تغییر وارد کنید">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تکرار رمز عبور</label>
                        <input type="password" id="modal-confirm-password" class="form-control" placeholder="تکرار رمز عبور">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">نقش کاربر</label>
                        <select id="modal-role" class="form-control">
                            <option value="user">کاربر عادی</option>
                            <option value="expert">کارشناس</option>
                            <option value="admin">مدیر سیستم</option>
                        </select>
                        <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                            فقط مدیر سیستم می‌تواند نقش کاربران را تغییر دهد
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">تاریخ انقضای حساب</label>
                        <input type="date" id="modal-expiry" class="form-control">
                    </div>
                </div>
                
                <div style="text-align: left; margin-top: 30px;">
                    <button class="btn btn-primary" id="modal-save-user-btn">
                        <i class="fas fa-save"></i> ذخیره کاربر
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال گزارش A4 -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">گزارش محاسبه تغذیه</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="a4-report">
                    <div class="report-header">
                        <div class="report-title">گزارش محاسبه نیازهای غذایی</div>
                        <div class="report-subtitle">سیستم جامع مدیریت تغذیه گیاهان</div>
                        <div style="margin-top: 15px; font-size: 14px; color: var(--text-secondary);">
                            توسعه‌دهنده: مجتبی فروغی - 09133343583
                        </div>
                        <div id="report-date" style="margin-top: 10px; font-size: 14px;"></div>
                    </div>
                    
                    <div class="report-body" id="report-content">
                        <!-- محتوای گزارش -->
                    </div>
                    
                    <div class="report-footer">
                        <p>این گزارش به صورت خودکار توسط سیستم جامع مدیریت تغذیه گیاهان تولید شده است.</p>
                        <p>تاریخ تولید: <span id="report-generation-date"></span></p>
                        <p style="font-size: 10px; margin-top: 10px;">وب‌سایت: srs-sepanta.ir</p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;" class="no-print">
                    <button class="btn btn-primary" id="print-a4-btn">
                        <i class="fas fa-print"></i> چاپ گزارش
                    </button>
                    <button class="btn btn-secondary" id="download-report-btn" style="margin-right: 10px;">
                        <i class="fas fa-download"></i> دانلود گزارش
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== سیستم جامع مدیریت تغذیه گیاهان ====================
        // نسخه اصلاح شده - رفع تمام باگ‌ها و مشکلات امنیتی
        
        class NutritionManagementSystem {
            constructor() {
                this.currentUser = null;
                this.users = {};
                this.prices = {};
                this.calculations = [];
                this.formulas = {};
                this.currentCalculation = null;
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.isAdmin = false;
                this.initialize();
            }
            
            async initialize() {
                await this.loadData();
                this.setupEventListeners();
                this.setupPlannerInputs();
                this.checkExpiredAccounts();
                await this.loadFormulas();
            }
            
            async loadData() {
                try {
                    // بارگذاری کاربران
                    const usersData = localStorage.getItem('nutrition_users');
                    if (usersData) {
                        this.users = JSON.parse(usersData);
                    } else {
                        await this.createDefaultUsers();
                    }
                    
                    // بارگذاری قیمت‌ها
                    const pricesData = localStorage.getItem('nutrition_prices');
                    if (pricesData) {
                        this.prices = JSON.parse(pricesData);
                    } else {
                        await this.createDefaultPrices();
                    }
                    
                    // بارگذاری محاسبات
                    const calculationsData = localStorage.getItem('nutrition_calculations');
                    if (calculationsData) {
                        this.calculations = JSON.parse(calculationsData);
                    }
                    
                    // بارگذاری فرمول‌ها
                    const formulasData = localStorage.getItem('nutrition_formulas');
                    if (formulasData) {
                        this.formulas = JSON.parse(formulasData);
                    } else {
                        await this.createDefaultFormulas();
                    }
                    
                    // بارگذاری کاربر جاری
                    const currentUserData = localStorage.getItem('currentUser');
                    if (currentUserData) {
                        this.currentUser = JSON.parse(currentUserData);
                        this.isAdmin = this.currentUser?.role === 'admin';
                        await this.showMainApp();
                    }
                } catch (error) {
                    console.error('خطا در بارگذاری داده‌ها:', error);
                    await this.createDefaultUsers();
                }
            }
            
            async createDefaultUsers() {
                this.users = {
                    'admin': {
                        username: 'admin',
                        password: await this.hashPassword('Admin@2024'),
                        fullName: 'مدیر سیستم',
                        email: 'admin@system.com',
                        phone: '09123456789',
                        role: 'admin',
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: null,
                        lastLogin: null,
                        permissions: {
                            crops: ['all'],
                            sections: ['all'],
                            reports: ['all']
                        },
                        loginLogs: []
                    },
                    'expert': {
                        username: 'expert',
                        password: await this.hashPassword('Expert@2024'),
                        fullName: 'کارشناس کشاورزی',
                        email: 'expert@system.com',
                        phone: '09129876543',
                        role: 'expert',
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: null,
                        lastLogin: null,
                        permissions: {
                            crops: ['wheat', 'rice', 'saffron', 'cucumber', 'tomato'],
                            sections: ['dashboard', 'planner', 'reports', 'history'],
                            reports: ['basic', 'detailed']
                        },
                        loginLogs: []
                    },
                    'user': {
                        username: 'user',
                        password: await this.hashPassword('User@2024'),
                        fullName: 'کاربر نمونه',
                        email: 'user@system.com',
                        phone: '09121234567',
                        role: 'user',
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: this.addDays(new Date(), 30).toISOString(),
                        lastLogin: null,
                        permissions: {
                            crops: ['wheat', 'saffron'],
                            sections: ['dashboard', 'planner', 'history'],
                            reports: ['basic']
                        },
                        loginLogs: []
                    }
                };
                
                await this.saveUsers();
            }
            
            async createDefaultPrices() {
                this.prices = {
                    elements: [
                        { id: 1, name: 'نیتروژن', symbol: 'N', price: 70000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 2, name: 'فسفر', symbol: 'P₂O₅', price: 120000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 3, name: 'پتاسیم', symbol: 'K₂O', price: 90000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 4, name: 'کلسیم', symbol: 'Ca', price: 30000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 5, name: 'منیزیم', symbol: 'Mg', price: 25000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 6, name: 'گوگرد', symbol: 'S', price: 20000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 7, name: 'آهن', symbol: 'Fe', price: 500000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 8, name: 'منگنز', symbol: 'Mn', price: 450000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 9, name: 'روی', symbol: 'Zn', price: 400000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() },
                        { id: 10, name: 'مس', symbol: 'Cu', price: 700000, unit: 'کیلوگرم', lastUpdate: new Date().toISOString() }
                    ],
                    history: []
                };
                
                await this.savePrices();
            }
            
            async createDefaultFormulas() {
                this.formulas = {
                    nitrogen: {
                        base: 70,
                        regionFactor: 1.0,
                        efficiency: 65,
                        leachingFactor: 0.15
                    },
                    phosphorus: {
                        base: 45,
                        phFactor: 1.0,
                        organicFactor: 1.0,
                        efficiency: 25
                    },
                    potassium: {
                        base: 80,
                        textureFactor: 1.0,
                        moistureFactor: 1.0,
                        efficiency: 70
                    },
                    regionFactors: {
                        north: 1.1,
                        central: 1.0,
                        south: 0.9,
                        east: 0.95,
                        west: 1.05
                    },
                    growthFactors: {
                        initial: 1.0,
                        vegetative: 1.2,
                        reproductive: 1.5,
                        ripening: 0.8
                    },
                    cropRequirements: {
                        wheat: { N: 120, P: 60, K: 80, Ca: 40, Mg: 20, S: 15 },
                        rice: { N: 150, P: 70, K: 100, Ca: 30, Mg: 15, S: 20 },
                        saffron: { N: 80, P: 40, K: 60, Ca: 25, Mg: 10, S: 10 },
                        cucumber: { N: 180, P: 90, K: 120, Ca: 50, Mg: 25, S: 20 },
                        tomato: { N: 200, P: 100, K: 150, Ca: 60, Mg: 30, S: 25 },
                        corn: { N: 220, P: 110, K: 130, Ca: 45, Mg: 20, S: 18 },
                        potato: { N: 160, P: 80, K: 200, Ca: 35, Mg: 15, S: 15 }
                    }
                };
                
                await this.saveFormulas();
            }
            
            setupEventListeners() {
                // رویدادهای احراز هویت
                document.getElementById('login-btn').addEventListener('click', () => this.handleLogin());
                document.getElementById('register-btn').addEventListener('click', () => this.handleRegister());
                
                // رویدادهای تب‌های احراز هویت
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabId = e.target.getAttribute('data-tab');
                        this.showAuthTab(tabId);
                    });
                });
                
                // رویدادهای ناوبری اصلی
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const screen = e.target.closest('.nav-btn').getAttribute('data-screen');
                        this.showScreen(screen);
                    });
                });
                
                // رویدادهای برنامه‌ریز
                document.querySelectorAll('.planner-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabId = e.target.getAttribute('data-tab') || 
                                     e.target.getAttribute('data-report-tab');
                        if (tabId) this.showPlannerTab(tabId);
                    });
                });
                
                // محاسبه نتایج
                document.getElementById('calculate-btn').addEventListener('click', () => this.calculateResults());
                
                // ذخیره گزارش
                document.getElementById('save-report-btn').addEventListener('click', () => this.saveCalculation());
                
                // چاپ
                document.getElementById('print-btn').addEventListener('click', () => window.print());
                document.getElementById('print-report-btn').addEventListener('click', () => this.printReport());
                document.getElementById('print-a4-btn').addEventListener('click', () => this.printA4Report());
                
                // مدیریت کاربران
                document.getElementById('add-user-btn').addEventListener('click', () => this.showUserModal());
                
                // ذخیره پروفایل
                document.getElementById('save-profile-btn').addEventListener('click', () => this.saveProfile());
                
                // رویدادهای کیبورد
                document.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (document.getElementById('login-form').classList.contains('active')) {
                            this.handleLogin();
                        } else if (document.getElementById('register-form').classList.contains('active')) {
                            this.handleRegister();
                        }
                    }
                });
                
                // خروج
                document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());
                
                // بستن مودال
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.closest('.modal').classList.remove('active');
                    });
                });
                
                // فیلتر تاریخچه
                document.getElementById('history-filter').addEventListener('change', () => this.loadHistory());
                document.getElementById('history-search').addEventListener('input', () => this.loadHistory());
                
                // مدیریت کاربر - ذخیره
                document.getElementById('modal-save-user-btn').addEventListener('click', () => this.saveUser());
            }
            
            setupPlannerInputs() {
                this.generateSoilInputs();
                this.generateWaterInputs();
            }
            
            generateSoilInputs() {
                const elements = [
                    { key: 'nitrogen', symbol: 'N', name: 'نیتروژن', unit: 'mg/kg' },
                    { key: 'phosphorus', symbol: 'P', name: 'فسفر', unit: 'mg/kg' },
                    { key: 'potassium', symbol: 'K', name: 'پتاسیم', unit: 'mg/kg' },
                    { key: 'calcium', symbol: 'Ca', name: 'کلسیم', unit: 'mg/kg' },
                    { key: 'magnesium', symbol: 'Mg', name: 'منیزیم', unit: 'mg/kg' },
                    { key: 'sulfur', symbol: 'S', name: 'گوگرد', unit: 'mg/kg' },
                    { key: 'iron', symbol: 'Fe', name: 'آهن', unit: 'mg/kg' },
                    { key: 'manganese', symbol: 'Mn', name: 'منگنز', unit: 'mg/kg' },
                    { key: 'zinc', symbol: 'Zn', name: 'روی', unit: 'mg/kg' },
                    { key: 'copper', symbol: 'Cu', name: 'مس', unit: 'mg/kg' }
                ];
                
                const container = document.getElementById('soil-inputs');
                if (!container) return;
                
                container.innerHTML = elements.map(element => `
                    <div class="form-group">
                        <label class="form-label">${element.name} (${element.symbol})</label>
                        <input type="number" class="form-control soil-input" 
                               data-element="${element.key}" placeholder="0" min="0" step="0.1" value="0">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            ${element.unit}
                        </div>
                    </div>
                `).join('');
            }
            
            generateWaterInputs() {
                const elements = [
                    { key: 'water_ph', symbol: 'pH', name: 'اسیدیته آب', unit: '' },
                    { key: 'water_ec', symbol: 'EC', name: 'هدایت الکتریکی', unit: 'dS/m' },
                    { key: 'water_salinity', symbol: 'TDS', name: 'شوری آب', unit: 'mg/L' },
                    { key: 'water_hardness', symbol: 'Hardness', name: 'سختی آب', unit: 'mg/L CaCO₃' }
                ];
                
                const container = document.getElementById('water-inputs');
                if (!container) return;
                
                container.innerHTML = elements.map(element => `
                    <div class="form-group">
                        <label class="form-label">${element.name} (${element.symbol})</label>
                        <input type="number" class="form-control water-input" 
                               data-element="${element.key}" placeholder="0" min="0" step="0.1" value="0">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            ${element.unit}
                        </div>
                    </div>
                `).join('');
            }
            
            async loadFormulas() {
                try {
                    if (this.formulas.nitrogen) {
                        const nBase = document.getElementById('formula-n-base');
                        const nRegion = document.getElementById('formula-n-region');
                        const nEfficiency = document.getElementById('formula-n-efficiency');
                        const nLeaching = document.getElementById('formula-n-leaching');
                        
                        if (nBase) nBase.value = this.formulas.nitrogen.base;
                        if (nRegion) nRegion.value = this.formulas.nitrogen.regionFactor;
                        if (nEfficiency) nEfficiency.value = this.formulas.nitrogen.efficiency;
                        if (nLeaching) nLeaching.value = this.formulas.nitrogen.leachingFactor;
                    }
                    
                    if (this.formulas.phosphorus) {
                        const pBase = document.getElementById('formula-p-base');
                        const pPh = document.getElementById('formula-p-ph');
                        const pEfficiency = document.getElementById('formula-p-efficiency');
                        const pOrganic = document.getElementById('formula-p-organic');
                        
                        if (pBase) pBase.value = this.formulas.phosphorus.base;
                        if (pPh) pPh.value = this.formulas.phosphorus.phFactor;
                        if (pEfficiency) pEfficiency.value = this.formulas.phosphorus.efficiency;
                        if (pOrganic) pOrganic.value = this.formulas.phosphorus.organicFactor;
                    }
                    
                    if (this.formulas.potassium) {
                        const kBase = document.getElementById('formula-k-base');
                        const kTexture = document.getElementById('formula-k-texture');
                        const kEfficiency = document.getElementById('formula-k-efficiency');
                        const kMoisture = document.getElementById('formula-k-moisture');
                        
                        if (kBase) kBase.value = this.formulas.potassium.base;
                        if (kTexture) kTexture.value = this.formulas.potassium.textureFactor;
                        if (kEfficiency) kEfficiency.value = this.formulas.potassium.efficiency;
                        if (kMoisture) kMoisture.value = this.formulas.potassium.moistureFactor;
                    }
                    
                    // بارگذاری ضرایب منطقه‌ای
                    if (this.formulas.regionFactors) {
                        const north = document.getElementById('factor-north');
                        const central = document.getElementById('factor-central');
                        const south = document.getElementById('factor-south');
                        const east = document.getElementById('factor-east');
                        const west = document.getElementById('factor-west');
                        
                        if (north) north.value = this.formulas.regionFactors.north;
                        if (central) central.value = this.formulas.regionFactors.central;
                        if (south) south.value = this.formulas.regionFactors.south;
                        if (east) east.value = this.formulas.regionFactors.east;
                        if (west) west.value = this.formulas.regionFactors.west;
                    }
                    
                    // بارگذاری ضرایب رشد
                    if (this.formulas.growthFactors) {
                        const initial = document.getElementById('factor-initial');
                        const vegetative = document.getElementById('factor-vegetative');
                        const reproductive = document.getElementById('factor-reproductive');
                        const ripening = document.getElementById('factor-ripening');
                        
                        if (initial) initial.value = this.formulas.growthFactors.initial;
                        if (vegetative) vegetative.value = this.formulas.growthFactors.vegetative;
                        if (reproductive) reproductive.value = this.formulas.growthFactors.reproductive;
                        if (ripening) ripening.value = this.formulas.growthFactors.ripening;
                    }
                } catch (error) {
                    console.error('خطا در بارگذاری فرمول‌ها:', error);
                }
            }
            
            showAuthTab(tabId) {
                document.querySelectorAll('.auth-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelectorAll('.auth-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const tabForm = document.getElementById(`${tabId}-form`);
                const tabElement = document.querySelector(`[data-tab="${tabId}"]`);
                
                if (tabForm) tabForm.classList.add('active');
                if (tabElement) tabElement.classList.add('active');
            }
            
            async handleLogin() {
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;
                
                if (!username || !password) {
                    this.showAlert('لطفا نام کاربری و رمز عبور را وارد کنید', 'error', 'login-alert');
                    return;
                }
                
                const user = this.users[username];
                
                if (!user) {
                    this.showAlert('نام کاربری یا رمز عبور اشتباه است', 'error', 'login-alert');
                    return;
                }
                
                const isPasswordValid = await this.verifyPassword(password, user.password);
                if (!isPasswordValid) {
                    this.showAlert('نام کاربری یا رمز عبور اشتباه است', 'error', 'login-alert');
                    return;
                }
                
                if (user.status !== 'active') {
                    this.showAlert('حساب کاربری شما غیرفعال است', 'error', 'login-alert');
                    return;
                }
                
                if (user.expiryDate && new Date(user.expiryDate) < new Date()) {
                    user.status = 'expired';
                    await this.saveUsers();
                    this.showAlert('حساب کاربری شما منقضی شده است', 'error', 'login-alert');
                    return;
                }
                
                user.lastLogin = new Date().toISOString();
                if (!user.loginLogs) user.loginLogs = [];
                user.loginLogs.push({
                    loginTime: user.lastLogin,
                    logoutTime: null,
                    duration: null
                });
                
                this.currentUser = {
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role,
                    email: user.email,
                    phone: user.phone,
                    permissions: user.permissions,
                    expiryDate: user.expiryDate
                };
                
                this.isAdmin = this.currentUser.role === 'admin';
                
                await this.saveUsers();
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                
                this.showAlert('ورود موفقیت‌آمیز! خوش آمدید', 'success', 'login-alert');
                setTimeout(() => this.showMainApp(), 1000);
            }
            
            async handleRegister() {
                const fullName = document.getElementById('register-fullname').value.trim();
                const username = document.getElementById('register-username').value.trim();
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                if (!fullName || !username || !email || !password) {
                    this.showAlert('لطفا تمام فیلدهای الزامی را پر کنید', 'error', 'register-alert');
                    return;
                }
                
                if (password.length < 8) {
                    this.showAlert('رمز عبور باید حداقل 8 کاراکتر باشد', 'error', 'register-alert');
                    return;
                }
                
                if (password !== confirmPassword) {
                    this.showAlert('رمز عبور و تکرار آن یکسان نیستند', 'error', 'register-alert');
                    return;
                }
                
                if (this.users[username]) {
                    this.showAlert('این نام کاربری قبلاً ثبت شده است', 'error', 'register-alert');
                    return;
                }
                
                // FIX: کاربر جدید همیشه نقش "user" دارد
                const newUser = {
                    username: username,
                    password: await this.hashPassword(password),
                    fullName: fullName,
                    email: email,
                    phone: '',
                    role: 'user', // همیشه کاربر عادی
                    status: 'pending', // نیاز به تأیید مدیر
                    registrationDate: new Date().toISOString(),
                    expiryDate: this.addDays(new Date(), 365).toISOString(),
                    lastLogin: null,
                    permissions: {
                        crops: ['wheat', 'saffron'],
                        sections: ['dashboard', 'planner', 'history'],
                        reports: ['basic']
                    },
                    loginLogs: []
                };
                
                this.users[username] = newUser;
                await this.saveUsers();
                
                this.showAlert('ثبت‌نام شما با موفقیت انجام شد. پس از تأیید مدیر می‌توانید وارد شوید.', 'success', 'register-alert');
                
                // پاک کردن فرم
                document.getElementById('register-fullname').value = '';
                document.getElementById('register-username').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
                document.getElementById('register-confirm-password').value = '';
                
                this.showAuthTab('login');
            }
            
            async showMainApp() {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                await this.updateUserInfo();
                await this.loadDashboard();
                this.checkPermissions();
            }
            
            async updateUserInfo() {
                if (!this.currentUser) return;
                
                const userInfo = document.getElementById('user-info');
                if (userInfo) {
                    userInfo.textContent = 
                        `${this.currentUser.fullName} (${this.getRoleName(this.currentUser.role)})`;
                }
                
                const adminElements = document.querySelectorAll('.admin-only');
                if (this.isAdmin) {
                    adminElements.forEach(el => el.style.display = 'flex');
                } else {
                    adminElements.forEach(el => el.style.display = 'none');
                }
                
                this.loadProfile();
            }
            
            getRoleName(role) {
                const roles = {
                    'admin': 'مدیر سیستم',
                    'expert': 'کارشناس',
                    'user': 'کاربر عادی'
                };
                return roles[role] || role;
            }
            
            checkPermissions() {
                if (!this.currentUser) return;
                
                const permissions = this.currentUser.permissions;
                
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    const screen = btn.getAttribute('data-screen');
                    if (!this.hasAccessToSection(screen)) {
                        btn.style.display = 'none';
                    }
                });
                
                this.updateCropPermissions();
            }
            
            hasAccessToSection(section) {
                if (!this.currentUser) return false;
                if (this.isAdmin) return true;
                
                const permissions = this.currentUser.permissions;
                if (permissions.sections.includes('all')) return true;
                
                const sectionMap = {
                    'dashboard': 'dashboard',
                    'planner': 'planner',
                    'reports': 'reports',
                    'history': 'history',
                    'profile': 'profile',
                    'users': 'users',
                    'prices': 'prices',
                    'formulas': 'formulas',
                    'access': 'access'
                };
                
                return permissions.sections.includes(sectionMap[section]);
            }
            
            updateCropPermissions() {
                if (!this.currentUser) return;
                
                const cropSelect = document.getElementById('crop-selection');
                if (!cropSelect) return;
                
                const permissions = this.currentUser.permissions;
                const allCrops = [
                    'wheat', 'rice', 'saffron', 'cucumber', 'tomato', 'corn', 'potato'
                ];
                
                if (permissions.crops.includes('all')) return;
                
                allCrops.forEach(crop => {
                    if (!permissions.crops.includes(crop)) {
                        const option = cropSelect.querySelector(`option[value="${crop}"]`);
                        if (option) {
                            option.disabled = true;
                        }
                    }
                });
            }
            
            showScreen(screenName) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                const activeBtn = document.querySelector(`.nav-btn[data-screen="${screenName}"]`);
                if (activeBtn) {
                    activeBtn.classList.add('active');
                }
                
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                
                const screenElement = document.getElementById(`${screenName}-screen`);
                if (screenElement) {
                    screenElement.classList.add('active');
                }
                
                switch(screenName) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'users':
                        if (this.isAdmin) this.loadUsersTable();
                        break;
                    case 'prices':
                        if (this.isAdmin) this.loadPricesTable();
                        break;
                    case 'formulas':
                        if (this.isAdmin) this.loadFormulasScreen();
                        break;
                    case 'access':
                        if (this.isAdmin) this.loadAccessControls();
                        break;
                    case 'history':
                        this.loadHistory();
                        break;
                    case 'reports':
                        this.loadReports();
                        break;
                }
            }
            
            nextPlannerTab(tabId) {
                this.showPlannerTab(tabId);
            }
            
            showPlannerTab(tabId) {
                document.querySelectorAll('.planner-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const activeTab = document.querySelector(`.planner-tab[data-tab="${tabId}"], .planner-tab[data-report-tab="${tabId}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                document.querySelectorAll('.planner-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const content = document.getElementById(`${tabId}-tab`);
                if (content) {
                    content.classList.add('active');
                }
                
                if (tabId === 'results' && !this.currentCalculation) {
                    this.calculateResults();
                }
            }
            
            calculateResults() {
                try {
                    const crop = document.getElementById('crop-selection').value;
                    const region = document.getElementById('region-selection').value;
                    const growthStage = document.getElementById('growth-stage').value;
                    const area = parseFloat(document.getElementById('cultivation-area').value) || 1;
                    
                    if (area <= 0) {
                        this.showAlert('لطفا مساحت معتبر وارد کنید', 'error');
                        return;
                    }
                    
                    const soilData = {};
                    document.querySelectorAll('.soil-input').forEach(input => {
                        const key = input.getAttribute('data-element');
                        soilData[key] = parseFloat(input.value) || 0;
                    });
                    
                    const waterData = {};
                    document.querySelectorAll('.water-input').forEach(input => {
                        const key = input.getAttribute('data-element');
                        waterData[key] = parseFloat(input.value) || 0;
                    });
                    
                    const recommendations = {};
                    let totalCost = 0;
                    
                    const elements = ['N', 'P', 'K', 'Ca', 'Mg', 'S'];
                    const cropRequirements = this.formulas.cropRequirements[crop] || this.formulas.cropRequirements.wheat;
                    
                    elements.forEach(element => {
                        const baseRequirement = cropRequirements[element];
                        const soilValue = soilData[element.toLowerCase()] || 0;
                        
                        const regionFactor = this.formulas.regionFactors[region] || 1.0;
                        const growthFactor = this.formulas.growthFactors[growthStage] || 1.0;
                        
                        const adjustedRequirement = baseRequirement * regionFactor * growthFactor;
                        const netRequirement = Math.max(0, adjustedRequirement - (soilValue / 1000)); // تبدیل mg/kg به kg/ha
                        
                        let efficiency;
                        switch(element) {
                            case 'N': efficiency = (this.formulas.nitrogen?.efficiency || 65) / 100; break;
                            case 'P': efficiency = (this.formulas.phosphorus?.efficiency || 25) / 100; break;
                            case 'K': efficiency = (this.formulas.potassium?.efficiency || 70) / 100; break;
                            default: efficiency = 0.6;
                        }
                        
                        const totalRequirement = (netRequirement / efficiency) * area;
                        
                        const priceElement = this.prices.elements?.find(el => 
                            el.symbol.includes(element)
                        );
                        
                        const price = priceElement ? priceElement.price : 10000;
                        const elementCost = totalRequirement * price;
                        
                        recommendations[element] = {
                            symbol: element,
                            name: this.getElementName(element),
                            requirement: totalRequirement,
                            unit: 'کیلوگرم',
                            price: price,
                            cost: elementCost,
                            soilValue: soilValue,
                            efficiency: efficiency * 100
                        };
                        
                        totalCost += elementCost;
                    });
                    
                    const micronutrients = ['Fe', 'Mn', 'Zn', 'Cu'];
                    micronutrients.forEach(element => {
                        const soilValue = soilData[element.toLowerCase()] || 0;
                        const baseRequirement = 0.5;
                        
                        if (soilValue < 0.3) {
                            const requirement = baseRequirement * area;
                            const priceElement = this.prices.elements?.find(el => 
                                el.symbol.includes(element)
                            );
                            
                            const price = priceElement ? priceElement.price : 100000;
                            const elementCost = requirement * price;
                            
                            recommendations[element] = {
                                symbol: element,
                                name: this.getElementName(element),
                                requirement: requirement,
                                unit: 'کیلوگرم',
                                price: price,
                                cost: elementCost,
                                soilValue: soilValue,
                                efficiency: 30
                            };
                            
                            totalCost += elementCost;
                        }
                    });
                    
                    this.currentCalculation = {
                        id: Date.now(),
                        date: new Date().toISOString(),
                        crop: crop,
                        region: region,
                        growthStage: growthStage,
                        area: area,
                        soilData: soilData,
                        waterData: waterData,
                        recommendations: recommendations,
                        totalCost: totalCost,
                        user: this.currentUser.username,
                        formulasUsed: {
                            nitrogen: this.formulas.nitrogen,
                            phosphorus: this.formulas.phosphorus,
                            potassium: this.formulas.potassium,
                            regionFactors: this.formulas.regionFactors,
                            growthFactors: this.formulas.growthFactors
                        }
                    };
                    
                    this.showResults();
                } catch (error) {
                    console.error('خطا در محاسبه نتایج:', error);
                    this.showAlert('خطا در محاسبه نتایج', 'error');
                }
            }
            
            showResults() {
                if (!this.currentCalculation) return;
                
                const cropNames = {
                    wheat: 'گندم',
                    rice: 'برنج',
                    saffron: 'زعفران',
                    cucumber: 'خیار',
                    tomato: 'گوجه فرنگی',
                    corn: 'ذرت',
                    potato: 'سیب زمینی'
                };
                
                const regionNames = {
                    north: 'شمال (خزر)',
                    central: 'مرکزی',
                    south: 'جنوب',
                    east: 'شرق',
                    west: 'غرب'
                };
                
                const growthStageNames = {
                    initial: 'مرحله ابتدایی',
                    vegetative: 'رشد رویشی',
                    reproductive: 'تولید مثل',
                    ripening: 'رسیدگی'
                };
                
                const summary = `
                    <div style="background: #F8F9FA; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary);">محصول</div>
                                <div style="font-size: 18px; font-weight: 600;">${cropNames[this.currentCalculation.crop] || this.currentCalculation.crop}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary);">منطقه</div>
                                <div style="font-size: 18px; font-weight: 600;">${regionNames[this.currentCalculation.region] || this.currentCalculation.region}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary);">مرحله رشد</div>
                                <div style="font-size: 18px; font-weight: 600;">${growthStageNames[this.currentCalculation.growthStage] || this.currentCalculation.growthStage}</div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary);">مساحت</div>
                                <div style="font-size: 18px; font-weight: 600;">${this.currentCalculation.area} هکتار</div>
                            </div>
                        </div>
                    </div>
                `;
                
                const summaryElement = document.getElementById('calculation-summary');
                if (summaryElement) summaryElement.innerHTML = summary;
                
                const container = document.getElementById('results-container');
                const recommendations = this.currentCalculation.recommendations;
                
                if (!container) return;
                
                if (Object.keys(recommendations).length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-check-circle" style="font-size: 48px; color: var(--success-color); margin-bottom: 20px;"></i>
                            <h3>خاک از نظر عناصر غذایی در وضعیت مطلوب است</h3>
                            <p>بر اساس آنالیز خاک، نیازی به کوددهی اضافی نمی‌باشد.</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = Object.values(recommendations).map(rec => `
                        <div class="card" style="padding: 20px; text-align: center; border-right: 4px solid var(--primary-color);">
                            <div style="font-size: 24px; font-weight: bold; color: var(--primary-color); margin-bottom: 10px;">
                                ${rec.symbol}
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                                ${rec.name}
                            </div>
                            <div style="font-size: 20px; font-weight: 600; margin-bottom: 5px;">
                                ${rec.requirement.toFixed(2)} ${rec.unit}
                            </div>
                            <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 10px;">
                                راندمان جذب: ${rec.efficiency}%
                            </div>
                            <div style="font-size: 16px; color: var(--success-color); font-weight: 600;">
                                ${this.formatCurrency(rec.cost)}
                            </div>
                        </div>
                    `).join('');
                }
                
                const totalCostElement = document.getElementById('total-cost');
                if (totalCostElement) {
                    totalCostElement.textContent = this.formatCurrency(this.currentCalculation.totalCost);
                }
                
                this.showPlannerTab('results');
            }
            
            async saveCalculation() {
                if (!this.currentCalculation) {
                    this.showAlert('ابتدا محاسبه‌ای انجام دهید', 'error');
                    return;
                }
                
                this.calculations.unshift(this.currentCalculation);
                localStorage.setItem('nutrition_calculations', JSON.stringify(this.calculations));
                
                this.showAlert('محاسبه با موفقیت ذخیره شد', 'success');
                this.loadDashboard();
            }
            
            async loadDashboard() {
                const activeUsers = Object.values(this.users).filter(user => user.status === 'active').length;
                
                const totalUsersElement = document.getElementById('total-users');
                const totalCalculationsElement = document.getElementById('total-calculations');
                const totalSavingsElement = document.getElementById('total-savings');
                const activeCropsElement = document.getElementById('active-crops');
                
                if (totalUsersElement) totalUsersElement.textContent = activeUsers;
                if (totalCalculationsElement) totalCalculationsElement.textContent = this.calculations.length;
                if (activeCropsElement) activeCropsElement.textContent = Object.keys(this.formulas.cropRequirements || {}).length;
                
                const totalSavings = this.calculations.reduce((sum, calc) => sum + (calc.totalCost * 0.15), 0);
                if (totalSavingsElement) totalSavingsElement.textContent = this.formatCurrency(totalSavings);
                
                this.loadRecentCalculations();
                this.loadRecentUsers();
            }
            
            loadRecentCalculations() {
                const container = document.getElementById('recent-calculations');
                if (!container) return;
                
                let userCalculations = this.calculations;
                if (!this.isAdmin) {
                    userCalculations = this.calculations.filter(calc => calc.user === this.currentUser.username);
                }
                
                const recent = userCalculations.slice(0, 5);
                
                if (recent.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">هنوز محاسبه‌ای انجام نشده است</p>';
                    return;
                }
                
                const cropNames = {
                    wheat: 'گندم',
                    rice: 'برنج',
                    saffron: 'زعفران',
                    cucumber: 'خیار',
                    tomato: 'گوجه فرنگی'
                };
                
                let html = '<table class="table" style="font-size: 14px;">';
                html += '<thead><tr><th>تاریخ</th><th>محصول</th><th>هزینه</th></tr></thead><tbody>';
                
                recent.forEach(calc => {
                    html += `
                        <tr>
                            <td>${new Date(calc.date).toLocaleDateString('fa-IR')}</td>
                            <td>${cropNames[calc.crop] || calc.crop}</td>
                            <td>${this.formatCurrency(calc.totalCost)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            loadRecentUsers() {
                const container = document.getElementById('recent-users');
                if (!container) return;
                
                if (!this.isAdmin) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">فقط مدیر سیستم می‌تواند کاربران را مشاهده کند</p>';
                    return;
                }
                
                const users = Object.values(this.users)
                    .sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate))
                    .slice(0, 5);
                
                if (users.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">کاربری یافت نشد</p>';
                    return;
                }
                
                let html = '<table class="table" style="font-size: 14px;">';
                html += '<thead><tr><th>نام</th><th>نقش</th><th>وضعیت</th></tr></thead><tbody>';
                
                users.forEach(user => {
                    const statusBadge = user.status === 'active' ? 
                        '<span class="badge badge-success">فعال</span>' :
                        user.status === 'pending' ?
                        '<span class="badge badge-warning">در انتظار</span>' :
                        '<span class="badge badge-danger">غیرفعال</span>';
                    
                    html += `
                        <tr>
                            <td>${user.fullName}</td>
                            <td>${this.getRoleName(user.role)}</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            loadUsersTable() {
                const container = document.getElementById('users-table-body');
                if (!container) return;
                
                let html = '';
                
                Object.values(this.users).forEach(user => {
                    const statusBadge = user.status === 'active' ? 
                        '<span class="badge badge-success">فعال</span>' :
                        user.status === 'pending' ?
                        '<span class="badge badge-warning">در انتظار</span>' :
                        '<span class="badge badge-danger">غیرفعال</span>';
                    
                    const expiryDate = user.expiryDate ? 
                        new Date(user.expiryDate).toLocaleDateString('fa-IR') : 'نامحدود';
                    
                    const actions = this.isAdmin ? `
                        <button class="btn btn-sm btn-secondary" onclick="system.editUser('${user.username}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm ${user.status === 'active' ? 'btn-danger' : 'btn-success'}" 
                                onclick="system.toggleUserStatus('${user.username}')" style="margin-right: 5px;">
                            <i class="fas fa-power-off"></i>
                        </button>
                    ` : '';
                    
                    html += `
                        <tr>
                            <td>${user.username}</td>
                            <td>${user.fullName}</td>
                            <td>${this.getRoleName(user.role)}</td>
                            <td>${statusBadge}</td>
                            <td>${expiryDate}</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
            }
            
            loadPricesTable() {
                const container = document.getElementById('prices-table');
                if (!container) return;
                
                let html = '';
                
                (this.prices.elements || []).forEach(element => {
                    const canEdit = this.isAdmin;
                    const buttonHtml = canEdit ? 
                        `<button class="btn btn-sm btn-primary" onclick="system.updatePrice(${element.id})">به‌روزرسانی</button>` :
                        `<button class="btn btn-sm btn-primary" disabled>به‌روزرسانی</button>`;
                    
                    html += `
                        <tr>
                            <td>${element.name}</td>
                            <td>${element.symbol}</td>
                            <td>${this.formatCurrency(element.price)}</td>
                            <td>
                                <input type="number" class="form-control" 
                                       id="price-${element.id}" 
                                       value="${element.price}"
                                       style="width: 150px; display: inline-block;"
                                       ${canEdit ? '' : 'disabled'}>
                            </td>
                            <td>${new Date(element.lastUpdate).toLocaleDateString('fa-IR')}</td>
                            <td>${buttonHtml}</td>
                        </tr>
                    `;
                });
                
                container.innerHTML = html;
                
                this.loadPriceHistory();
            }
            
            loadPriceHistory() {
                const container = document.getElementById('price-history-list');
                if (!container) return;
                
                const history = (this.prices.history || []).slice(0, 10);
                
                if (history.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">تاریخچه‌ای موجود نیست</p>';
                    return;
                }
                
                let html = '<table class="table" style="font-size: 14px;">';
                html += '<thead><tr><th>تاریخ</th><th>عنصر</th><th>قیمت قدیم</th><th>قیمت جدید</th><th>تغییر توسط</th></tr></thead><tbody>';
                
                history.forEach(record => {
                    html += `
                        <tr>
                            <td>${new Date(record.date).toLocaleDateString('fa-IR')}</td>
                            <td>${record.element}</td>
                            <td>${this.formatCurrency(record.oldPrice)}</td>
                            <td>${this.formatCurrency(record.newPrice)}</td>
                            <td>${record.changedBy}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            loadReports() {
                const container = document.getElementById('reports-container');
                if (!container) return;
                
                let userReports = this.calculations;
                if (!this.isAdmin) {
                    userReports = this.calculations.filter(calc => calc.user === this.currentUser.username);
                }
                
                if (userReports.length === 0) {
                    container.innerHTML = `
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                        <p>گزارشی برای نمایش وجود ندارد</p>
                        <p style="margin-top: 10px; font-size: 14px;">برای ایجاد گزارش، ابتدا محاسبه‌ای انجام دهید</p>
                    `;
                    return;
                }
                
                const cropNames = {
                    wheat: 'گندم',
                    rice: 'برنج',
                    saffron: 'زعفران',
                    cucumber: 'خیار',
                    tomato: 'گوجه فرنگی'
                };
                
                let html = '<table class="table">';
                html += '<thead><tr><th>تاریخ</th><th>محصول</th><th>منطقه</th><th>هزینه کل</th><th>عملیات</th></tr></thead><tbody>';
                
                userReports.forEach(calc => {
                    html += `
                        <tr>
                            <td>${new Date(calc.date).toLocaleDateString('fa-IR')}</td>
                            <td>${cropNames[calc.crop] || calc.crop}</td>
                            <td>${calc.region}</td>
                            <td>${this.formatCurrency(calc.totalCost)}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="system.viewReport(${calc.id})">
                                    <i class="fas fa-eye"></i> مشاهده
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
            }
            
            loadFormulasScreen() {
                // بارگذاری فرمول‌ها قبلاً انجام شده
            }
            
            loadAccessControls() {
                const userSelect = document.getElementById('user-select');
                if (!userSelect) return;
                
                let options = '<option value="">یک کاربر انتخاب کنید</option>';
                Object.values(this.users).forEach(user => {
                    if (user.username !== 'admin') {
                        options += `<option value="${user.username}">${user.fullName} (${this.getRoleName(user.role)})</option>`;
                    }
                });
                
                userSelect.innerHTML = options;
                
                userSelect.addEventListener('change', (e) => {
                    const username = e.target.value;
                    if (username) {
                        this.showUserPermissions(username);
                    }
                });
            }
            
            showUserPermissions(username) {
                const user = this.users[username];
                if (!user) return;
                
                const container = document.getElementById('access-controls');
                if (!container) return;
                
                const permissions = user.permissions;
                
                const html = `
                    <h3>دسترسی‌های ${user.fullName}</h3>
                    
                    <div class="permission-section">
                        <h4 class="permission-title">محصولات مجاز</h4>
                        ${this.createPermissionCheckboxes('crops', permissions.crops)}
                    </div>
                    
                    <div class="permission-section">
                        <h4 class="permission-title">بخش‌های مجاز</h4>
                        ${this.createPermissionCheckboxes('sections', permissions.sections)}
                    </div>
                    
                    <div class="permission-section">
                        <h4 class="permission-title">گزارش‌های مجاز</h4>
                        ${this.createPermissionCheckboxes('reports', permissions.reports)}
                    </div>
                    
                    <div class="form-group" style="margin-top: 30px;">
                        <label class="form-label">تاریخ انقضای دسترسی</label>
                        <input type="date" id="user-expiry-date" class="form-control" 
                               value="${user.expiryDate ? user.expiryDate.split('T')[0] : ''}">
                    </div>
                    
                    <div style="text-align: left; margin-top: 20px;">
                        <button class="btn btn-primary" onclick="system.savePermissions('${username}')">
                            <i class="fas fa-save"></i> ذخیره دسترسی‌ها
                        </button>
                    </div>
                `;
                
                container.innerHTML = html;
            }
            
            createPermissionCheckboxes(type, selectedValues) {
                const options = {
                    crops: [
                        { value: 'all', label: 'همه محصولات' },
                        { value: 'wheat', label: 'گندم' },
                        { value: 'rice', label: 'برنج' },
                        { value: 'saffron', label: 'زعفران' },
                        { value: 'cucumber', label: 'خیار' },
                        { value: 'tomato', label: 'گوجه فرنگی' },
                        { value: 'corn', label: 'ذرت' },
                        { value: 'potato', label: 'سیب زمینی' }
                    ],
                    sections: [
                        { value: 'all', label: 'همه بخش‌ها' },
                        { value: 'dashboard', label: 'داشبورد' },
                        { value: 'planner', label: 'برنامه‌ریز' },
                        { value: 'reports', label: 'گزارش‌ها' },
                        { value: 'history', label: 'تاریخچه' }
                    ],
                    reports: [
                        { value: 'all', label: 'همه گزارش‌ها' },
                        { value: 'basic', label: 'گزارش پایه' },
                        { value: 'detailed', label: 'گزارش تفصیلی' }
                    ]
                };
                
                return (options[type] || []).map(option => `
                    <div class="permission-item">
                        <label>
                            <input type="checkbox" 
                                   name="${type}" 
                                   value="${option.value}"
                                   ${(selectedValues || []).includes('all') || (selectedValues || []).includes(option.value) ? 'checked' : ''}
                                   ${option.value === 'all' ? 'onchange="system.toggleAllCheckboxes(this, \'' + type + '\')"' : ''}>
                            ${option.label}
                        </label>
                    </div>
                `).join('');
            }
            
            toggleAllCheckboxes(checkbox, type) {
                const checkboxes = document.querySelectorAll(`input[name="${type}"]`);
                const isChecked = checkbox.checked;
                
                checkboxes.forEach(cb => {
                    cb.checked = isChecked;
                });
            }
            
            loadProfile() {
                if (!this.currentUser) return;
                
                const user = this.users[this.currentUser.username];
                if (!user) return;
                
                document.getElementById('profile-fullname').value = user.fullName;
                document.getElementById('profile-username').value = user.username;
                document.getElementById('profile-email').value = user.email || '';
                document.getElementById('profile-phone').value = user.phone || '';
                document.getElementById('profile-role').value = this.getRoleName(user.role);
                
                const expiryDate = user.expiryDate ? 
                    new Date(user.expiryDate).toLocaleDateString('fa-IR') : 'نامحدود';
                document.getElementById('profile-expiry').value = expiryDate;
            }
            
            async saveProfile() {
                if (!this.currentUser) return;
                
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-new-password').value;
                
                if (newPassword && newPassword !== confirmPassword) {
                    this.showAlert('رمز عبور و تکرار آن یکسان نیستند', 'error');
                    return;
                }
                
                const user = this.users[this.currentUser.username];
                if (user) {
                    user.email = document.getElementById('profile-email').value;
                    user.phone = document.getElementById('profile-phone').value;
                    
                    if (newPassword) {
                        user.password = await this.hashPassword(newPassword);
                    }
                    
                    await this.saveUsers();
                    
                    this.currentUser.email = user.email;
                    this.currentUser.phone = user.phone;
                    localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                    
                    this.showAlert('اطلاعات با موفقیت ذخیره شد', 'success');
                    
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-new-password').value = '';
                }
            }
            
            showUserModal(user = null) {
                document.getElementById('user-modal').classList.add('active');
                this.resetUserModal();
                
                if (user) {
                    this.editUser(user);
                }
            }
            
            resetUserModal() {
                document.getElementById('modal-username').value = '';
                document.getElementById('modal-fullname').value = '';
                document.getElementById('modal-email').value = '';
                document.getElementById('modal-phone').value = '';
                document.getElementById('modal-password').value = '';
                document.getElementById('modal-confirm-password').value = '';
                document.getElementById('modal-role').value = 'user';
                document.getElementById('modal-expiry').value = '';
                
                // غیرفعال کردن فیلد نقش برای کاربران غیر مدیر
                document.getElementById('modal-role').disabled = !this.isAdmin;
            }
            
            editUser(username) {
                const user = this.users[username];
                if (!user) return;
                
                document.getElementById('modal-username').value = user.username;
                document.getElementById('modal-fullname').value = user.fullName;
                document.getElementById('modal-email').value = user.email || '';
                document.getElementById('modal-phone').value = user.phone || '';
                document.getElementById('modal-role').value = user.role;
                
                if (user.expiryDate) {
                    document.getElementById('modal-expiry').value = user.expiryDate.split('T')[0];
                }
                
                document.getElementById('modal-username').disabled = true;
                document.getElementById('modal-role').disabled = !this.isAdmin;
            }
            
            async saveUser() {
                const username = document.getElementById('modal-username').value;
                const fullName = document.getElementById('modal-fullname').value;
                const email = document.getElementById('modal-email').value;
                const phone = document.getElementById('modal-phone').value;
                const password = document.getElementById('modal-password').value;
                const confirmPassword = document.getElementById('modal-confirm-password').value;
                const role = document.getElementById('modal-role').value;
                const expiryDate = document.getElementById('modal-expiry').value;
                
                if (!username || !fullName) {
                    this.showAlert('لطفا نام کاربری و نام کامل را وارد کنید', 'error', 'user-modal-alert');
                    return;
                }
                
                if (password && password !== confirmPassword) {
                    this.showAlert('رمز عبور و تکرار آن یکسان نیستند', 'error', 'user-modal-alert');
                    return;
                }
                
                let user = this.users[username];
                const isNewUser = !user;
                
                if (isNewUser) {
                    if (this.users[username]) {
                        this.showAlert('این نام کاربری قبلاً ثبت شده است', 'error', 'user-modal-alert');
                        return;
                    }
                    
                    user = {
                        username: username,
                        password: await this.hashPassword(password || 'User@2024'),
                        fullName: fullName,
                        email: email,
                        phone: phone,
                        role: role,
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: expiryDate ? new Date(expiryDate).toISOString() : null,
                        lastLogin: null,
                        permissions: {
                            crops: ['wheat', 'saffron'],
                            sections: ['dashboard', 'planner', 'history'],
                            reports: ['basic']
                        },
                        loginLogs: []
                    };
                } else {
                    user.fullName = fullName;
                    user.email = email;
                    user.phone = phone;
                    
                    // فقط مدیر می‌تواند نقش را تغییر دهد
                    if (this.isAdmin) {
                        user.role = role;
                    }
                    
                    if (expiryDate) {
                        user.expiryDate = new Date(expiryDate).toISOString();
                    }
                    
                    if (password) {
                        user.password = await this.hashPassword(password);
                    }
                }
                
                this.users[username] = user;
                await this.saveUsers();
                
                this.showAlert(`کاربر با موفقیت ${isNewUser ? 'ایجاد' : 'به‌روزرسانی'} شد`, 'success');
                document.getElementById('user-modal').classList.remove('active');
                this.loadUsersTable();
                this.loadDashboard();
            }
            
            async toggleUserStatus(username) {
                const user = this.users[username];
                if (!user) return;
                
                if (user.status === 'active') {
                    user.status = 'inactive';
                    this.showAlert(`کاربر ${user.fullName} غیرفعال شد`, 'warning');
                } else {
                    user.status = 'active';
                    this.showAlert(`کاربر ${user.fullName} فعال شد`, 'success');
                }
                
                await this.saveUsers();
                this.loadUsersTable();
                this.loadDashboard();
            }
            
            async updatePrice(elementId) {
                const newPriceInput = document.getElementById(`price-${elementId}`);
                if (!newPriceInput) return;
                
                const newPrice = parseInt(newPriceInput.value);
                
                if (!newPrice || newPrice < 0) {
                    this.showAlert('لطفا قیمت معتبر وارد کنید', 'error');
                    return;
                }
                
                const element = (this.prices.elements || []).find(el => el.id === elementId);
                if (!element) return;
                
                (this.prices.history || []).unshift({
                    date: new Date().toISOString(),
                    element: element.name,
                    oldPrice: element.price,
                    newPrice: newPrice,
                    changedBy: this.currentUser.fullName
                });
                
                element.price = newPrice;
                element.lastUpdate = new Date().toISOString();
                
                await this.savePrices();
                this.showAlert('قیمت با موفقیت به‌روزرسانی شد', 'success');
                this.loadPricesTable();
            }
            
            async saveFormula(formulaType) {
                if (!this.isAdmin) {
                    this.showAlert('فقط مدیر سیستم می‌تواند فرمول‌ها را تغییر دهد', 'error');
                    return;
                }
                
                try {
                    switch(formulaType) {
                        case 'nitrogen':
                            this.formulas.nitrogen = {
                                base: parseFloat(document.getElementById('formula-n-base').value),
                                regionFactor: parseFloat(document.getElementById('formula-n-region').value),
                                efficiency: parseFloat(document.getElementById('formula-n-efficiency').value),
                                leachingFactor: parseFloat(document.getElementById('formula-n-leaching').value)
                            };
                            break;
                        
                        case 'phosphorus':
                            this.formulas.phosphorus = {
                                base: parseFloat(document.getElementById('formula-p-base').value),
                                phFactor: parseFloat(document.getElementById('formula-p-ph').value),
                                organicFactor: parseFloat(document.getElementById('formula-p-organic').value),
                                efficiency: parseFloat(document.getElementById('formula-p-efficiency').value)
                            };
                            break;
                        
                        case 'potassium':
                            this.formulas.potassium = {
                                base: parseFloat(document.getElementById('formula-k-base').value),
                                textureFactor: parseFloat(document.getElementById('formula-k-texture').value),
                                moistureFactor: parseFloat(document.getElementById('formula-k-moisture').value),
                                efficiency: parseFloat(document.getElementById('formula-k-efficiency').value)
                            };
                            break;
                    }
                    
                    await this.saveFormulas();
                    this.showAlert('فرمول با موفقیت ذخیره شد', 'success');
                } catch (error) {
                    console.error('خطا در ذخیره فرمول:', error);
                    this.showAlert('خطا در ذخیره فرمول', 'error');
                }
            }
            
            async saveAllFactors() {
                if (!this.isAdmin) {
                    this.showAlert('فقط مدیر سیستم می‌تواند ضرایب را تغییر دهد', 'error');
                    return;
                }
                
                try {
                    this.formulas.regionFactors = {
                        north: parseFloat(document.getElementById('factor-north').value),
                        central: parseFloat(document.getElementById('factor-central').value),
                        south: parseFloat(document.getElementById('factor-south').value),
                        east: parseFloat(document.getElementById('factor-east').value),
                        west: parseFloat(document.getElementById('factor-west').value)
                    };
                    
                    this.formulas.growthFactors = {
                        initial: parseFloat(document.getElementById('factor-initial').value),
                        vegetative: parseFloat(document.getElementById('factor-vegetative').value),
                        reproductive: parseFloat(document.getElementById('factor-reproductive').value),
                        ripening: parseFloat(document.getElementById('factor-ripening').value)
                    };
                    
                    await this.saveFormulas();
                    this.showAlert('همه ضرایب با موفقیت ذخیره شدند', 'success');
                } catch (error) {
                    console.error('خطا در ذخیره ضرایب:', error);
                    this.showAlert('خطا در ذخیره ضرایب', 'error');
                }
            }
            
            async savePermissions(username) {
                if (!this.isAdmin) {
                    this.showAlert('فقط مدیر سیستم می‌تواند دسترسی‌ها را تغییر دهد', 'error');
                    return;
                }
                
                const user = this.users[username];
                if (!user) return;
                
                const crops = Array.from(document.querySelectorAll('input[name="crops"]:checked'))
                    .map(cb => cb.value);
                
                const sections = Array.from(document.querySelectorAll('input[name="sections"]:checked'))
                    .map(cb => cb.value);
                
                const reports = Array.from(document.querySelectorAll('input[name="reports"]:checked'))
                    .map(cb => cb.value);
                
                const expiryDate = document.getElementById('user-expiry-date').value;
                
                user.permissions = {
                    crops: crops,
                    sections: sections,
                    reports: reports
                };
                
                if (expiryDate) {
                    user.expiryDate = new Date(expiryDate).toISOString();
                }
                
                await this.saveUsers();
                this.showAlert('دسترسی‌ها با موفقیت ذخیره شدند', 'success');
            }
            
            loadHistory() {
                this.currentPage = 1;
                this.loadHistoryPage();
            }
            
            loadHistoryPage() {
                const container = document.getElementById('history-table-body');
                if (!container) return;
                
                const searchTerm = document.getElementById('history-search').value.toLowerCase();
                const filter = document.getElementById('history-filter').value;
                
                let filteredCalculations = this.calculations;
                
                if (!this.isAdmin) {
                    filteredCalculations = this.calculations.filter(calc => calc.user === this.currentUser.username);
                }
                
                if (searchTerm) {
                    filteredCalculations = filteredCalculations.filter(calc => 
                        calc.crop.toLowerCase().includes(searchTerm) ||
                        calc.region.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filter === 'my-history' && this.currentUser) {
                    filteredCalculations = filteredCalculations.filter(calc => calc.user === this.currentUser.username);
                } else if (filter === 'last-week') {
                    const lastWeek = new Date();
                    lastWeek.setDate(lastWeek.getDate() - 7);
                    filteredCalculations = filteredCalculations.filter(calc => new Date(calc.date) >= lastWeek);
                } else if (filter === 'last-month') {
                    const lastMonth = new Date();
                    lastMonth.setMonth(lastMonth.getMonth() - 1);
                    filteredCalculations = filteredCalculations.filter(calc => new Date(calc.date) >= lastMonth);
                } else if (filter === 'last-year') {
                    const lastYear = new Date();
                    lastYear.setFullYear(lastYear.getFullYear() - 1);
                    filteredCalculations = filteredCalculations.filter(calc => new Date(calc.date) >= lastYear);
                }
                
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const pageItems = filteredCalculations.slice(startIndex, endIndex);
                
                const cropNames = {
                    wheat: 'گندم',
                    rice: 'برنج',
                    saffron: 'زعفران',
                    cucumber: 'خیار',
                    tomato: 'گوجه فرنگی',
                    corn: 'ذرت',
                    potato: 'سیب زمینی'
                };
                
                let html = '';
                
                pageItems.forEach(calc => {
                    html += `
                        <tr>
                            <td>${new Date(calc.date).toLocaleDateString('fa-IR')}</td>
                            <td>${cropNames[calc.crop] || calc.crop}</td>
                            <td>${calc.region}</td>
                            <td>${calc.area} هکتار</td>
                            <td>${this.formatCurrency(calc.totalCost)}</td>
                            <td>
                                <button class="btn btn-sm btn-secondary" onclick="system.viewReport(${calc.id})">
                                    <i class="fas fa-eye"></i> مشاهده
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                if (html === '') {
                    html = `<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">موردی یافت نشد</td></tr>`;
                }
                
                container.innerHTML = html;
                
                const totalPages = Math.ceil(filteredCalculations.length / this.itemsPerPage);
                document.getElementById('page-info').textContent = `صفحه ${this.currentPage} از ${totalPages || 1}`;
                
                document.getElementById('prev-page').disabled = this.currentPage <= 1;
                document.getElementById('next-page').disabled = this.currentPage >= totalPages;
            }
            
            prevPage() {
                if (this.currentPage > 1) {
                    this.currentPage--;
                    this.loadHistoryPage();
                }
            }
            
            nextPage() {
                const totalPages = Math.ceil(this.calculations.length / this.itemsPerPage);
                if (this.currentPage < totalPages) {
                    this.currentPage++;
                    this.loadHistoryPage();
                }
            }
            
            viewReport(calculationId) {
                const calculation = this.calculations.find(c => c.id === calculationId);
                if (!calculation) return;
                
                if (!this.isAdmin && calculation.user !== this.currentUser.username) {
                    this.showAlert('شما دسترسی به این گزارش را ندارید', 'error');
                    return;
                }
                
                const cropNames = {
                    wheat: 'گندم',
                    rice: 'برنج',
                    saffron: 'زعفران',
                    cucumber: 'خیار',
                    tomato: 'گوجه فرنگی',
                    corn: 'ذرت',
                    potato: 'سیب زمینی'
                };
                
                const regionNames = {
                    north: 'شمال (خزر)',
                    central: 'مرکزی',
                    south: 'جنوب',
                    east: 'شرق',
                    west: 'غرب'
                };
                
                let reportContent = `
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">گزارش محاسبه تغذیه</h3>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <div>
                                <strong>محصول:</strong> ${cropNames[calculation.crop] || calculation.crop}
                            </div>
                            <div>
                                <strong>منطقه:</strong> ${regionNames[calculation.region] || calculation.region}
                            </div>
                            <div>
                                <strong>مساحت:</strong> ${calculation.area} هکتار
                            </div>
                            <div>
                                <strong>تاریخ محاسبه:</strong> ${new Date(calculation.date).toLocaleDateString('fa-IR')}
                            </div>
                            <div>
                                <strong>کاربر:</strong> ${calculation.user}
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="color: var(--primary-color); margin: 20px 0;">نتایج محاسبه</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: var(--primary-color); color: white;">
                                <th style="padding: 10px; text-align: right;">عنصر</th>
                                <th style="padding: 10px; text-align: right;">مقدار مورد نیاز</th>
                                <th style="padding: 10px; text-align: right;">هزینه</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                Object.values(calculation.recommendations || {}).forEach(rec => {
                    reportContent += `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 10px;">${rec.name} (${rec.symbol})</td>
                            <td style="padding: 10px;">${rec.requirement.toFixed(2)} ${rec.unit}</td>
                            <td style="padding: 10px; color: var(--success-color); font-weight: 600;">
                                ${this.formatCurrency(rec.cost)}
                            </td>
                        </tr>
                    `;
                });
                
                reportContent += `
                        </tbody>
                    </table>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; margin-top: 30px;">
                        <div style="font-size: 18px; margin-bottom: 10px; color: var(--text-primary);">
                            هزینه کل مورد نیاز
                        </div>
                        <div style="font-size: 32px; font-weight: 800; color: var(--success-color);">
                            ${this.formatCurrency(calculation.totalCost)}
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 1px solid var(--success-color);">
                        <strong>استانداردهای مورد استفاده:</strong><br>
                        - FAO Fertilizer Recommendations<br>
                        - استانداردهای مؤسسه تحقیقات خاک و آب ایران<br>
                        - روش Olsen برای خاک‌های قلیایی<br>
                        - استانداردهای ملی ایران (ISIRI)
                    </div>
                `;
                
                document.getElementById('report-content').innerHTML = reportContent;
                document.getElementById('report-date').textContent = `تاریخ گزارش: ${new Date().toLocaleDateString('fa-IR')}`;
                document.getElementById('report-generation-date').textContent = new Date().toLocaleDateString('fa-IR');
                
                document.getElementById('report-modal').classList.add('active');
            }
            
            printReport() {
                if (!this.currentCalculation) {
                    this.showAlert('ابتدا محاسبه‌ای انجام دهید', 'error');
                    return;
                }
                
                this.viewReport(this.currentCalculation.id);
                setTimeout(() => {
                    const printBtn = document.getElementById('print-a4-btn');
                    if (printBtn) printBtn.click();
                }, 500);
            }
            
            printA4Report() {
                window.print();
            }
            
            async handleLogout() {
                if (this.currentUser) {
                    const username = this.currentUser.username;
                    const user = this.users[username];
                    
                    if (user && user.loginLogs && user.loginLogs.length > 0) {
                        const lastLog = user.loginLogs[user.loginLogs.length - 1];
                        if (lastLog && !lastLog.logoutTime) {
                            lastLog.logoutTime = new Date().toISOString();
                            const loginTime = new Date(lastLog.loginTime);
                            lastLog.duration = Math.round((new Date() - loginTime) / (1000 * 60));
                            await this.saveUsers();
                        }
                    }
                }
                
                this.currentUser = null;
                this.isAdmin = false;
                localStorage.removeItem('currentUser');
                
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'flex';
                
                document.getElementById('login-username').value = '';
                document.getElementById('login-password').value = '';
                
                this.showAuthTab('login');
            }
            
            checkExpiredAccounts() {
                const today = new Date();
                let hasExpired = false;
                
                Object.values(this.users).forEach(user => {
                    if (user.expiryDate && new Date(user.expiryDate) < today && user.status === 'active') {
                        user.status = 'expired';
                        hasExpired = true;
                    }
                });
                
                if (hasExpired) {
                    this.saveUsers();
                }
            }
            
            // ==================== توابع کمکی بهبود یافته ====================
            
            async hashPassword(password) {
                // استفاده از SHA-256 برای هش کردن رمز عبور
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex;
            }
            
            async verifyPassword(password, hash) {
                const newHash = await this.hashPassword(password);
                return newHash === hash;
            }
            
            addDays(date, days) {
                const result = new Date(date);
                result.setDate(result.getDate() + days);
                return result;
            }
            
            formatCurrency(amount) {
                return new Intl.NumberFormat('fa-IR').format(Math.round(amount)) + ' ریال';
            }
            
            getElementName(symbol) {
                const elements = {
                    'N': 'نیتروژن',
                    'P': 'فسفر',
                    'K': 'پتاسیم',
                    'Ca': 'کلسیم',
                    'Mg': 'منیزیم',
                    'S': 'گوگرد',
                    'Fe': 'آهن',
                    'Mn': 'منگنز',
                    'Zn': 'روی',
                    'Cu': 'مس'
                };
                return elements[symbol] || symbol;
            }
            
            showAlert(message, type = 'info', elementId = null) {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                    type === 'error' ? 'exclamation-circle' : 
                                    type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                `;
                
                if (elementId) {
                    const container = document.getElementById(elementId);
                    if (container) {
                        container.innerHTML = '';
                        container.appendChild(alertDiv);
                        container.style.display = 'block';
                    }
                } else {
                    const appContent = document.querySelector('.app-content');
                    if (appContent) {
                        appContent.insertBefore(alertDiv, appContent.firstChild);
                    }
                }
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
            
            async saveUsers() {
                localStorage.setItem('nutrition_users', JSON.stringify(this.users));
            }
            
            async savePrices() {
                localStorage.setItem('nutrition_prices', JSON.stringify(this.prices));
            }
            
            async saveFormulas() {
                localStorage.setItem('nutrition_formulas', JSON.stringify(this.formulas));
            }
        }

        // راه‌اندازی سیستم
        document.addEventListener('DOMContentLoaded', async () => {
            window.system = new NutritionManagementSystem();
        });
    </script>
</body>
</html>
