<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم جامع مدیریت تغذیه گیاهان</title>
    
   <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v33.0.2/dist/font-face.css" rel="stylesheet">
    
    <!-- لینک jQuery برای مدیریت بهتر DOM -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <!-- لینک jsPDF برای تولید PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* استایل‌های پایه */
        :root {
            --primary-color: #1a5f23;
            --primary-light: #2e8b32;
            --primary-dark: #0d4513;
            --secondary-color: #1565C0;
            --accent-color: #FF9800;
            --error-color: #C62828;
            --warning-color: #F57C00;
            --success-color: #388E3C;
            --info-color: #0288D1;
            --background-color: #F5F7FA;
            --card-color: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #546E7A;
            --border-color: #E0E0E0;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Vazir, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* بقیه استایل‌ها (همانند فایل اصلی) */
        /* ... تمام استایل‌های موجود قبلی ... */
        
        /* اضافه کردن استایل‌های جدید برای اصلاح مشکلات */
        .auth-container {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .password-toggle {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .password-wrapper {
            position: relative;
        }
        
        .input-with-icon {
            position: relative;
        }
        
        .input-with-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .input-with-icon input {
            padding-right: 40px !important;
        }
        
        /* بهبود استایل‌های چاپ */
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .a4-report {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                margin: 0 !important;
                padding: 15mm !important;
            }
            
            .report-header {
                border-bottom: 3px solid var(--primary-color) !important;
            }
        }
        
        /* بهبود اسکرول‌بار */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* استایل‌های بهبود یافته برای جدول‌ها */
        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* استایل‌های پیش‌فرض برای نمایش/مخفی کردن */
        [data-screen] {
            display: none;
        }
        
        [data-screen].active {
            display: block;
        }
        
        /* استایل‌های جدید برای دکمه‌های عملیاتی */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        
        /* استایل‌های جدید برای فرم‌ها */
        .form-control:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        /* استایل‌های جدید برای انتخاب تاریخ */
        .date-picker {
            font-family: Vazir, sans-serif;
        }
        
        /* استایل‌های جدید برای نمایش وضعیت */
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-pending {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .status-inactive {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .status-expired {
            background-color: #f5f5f5;
            color: #616161;
        }
        
        /* استایل‌های جدید برای کارت‌های داشبورد */
        .stat-card:hover .stat-icon {
            transform: scale(1.1);
            transition: var(--transition);
        }
        
        /* استایل‌های جدید برای تاییدیه */
        .confirmation-modal {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* استایل‌های جدید برای بارگذاری */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* استایل‌های جدید برای پیام‌های خالی */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 48px;
            opacity: 0.3;
            margin-bottom: 20px;
        }
        
        /* استایل‌های جدید برای ناوبری موبایل */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            right: 0;
            left: 0;
            background: white;
            border-top: 1px solid var(--border-color);
            padding: 10px;
            z-index: 1000;
        }
        
        .mobile-nav-btn {
            flex: 1;
            text-align: center;
            padding: 10px;
            border: none;
            background: none;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .mobile-nav-btn.active {
            color: var(--primary-color);
        }
        
        /* بهبود پاسخگویی */
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
            }
            
            .app-nav {
                display: none;
            }
            
            .app-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr !important;
            }
            
            .input-grid {
                grid-template-columns: 1fr !important;
            }
            
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }
        
        /* استایل‌های جدید برای مدیریت خطا */
        .error-boundary {
            background: #ffebee;
            border: 1px solid var(--error-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        /* استایل‌های جدید برای توضیحات */
        .form-help {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        /* استایل‌های جدید برای فیلدهای اجباری */
        .required::after {
            content: " *";
            color: var(--error-color);
        }
        
        /* استایل‌های جدید برای گروه‌بندی فرم */
        .form-section {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            border-right: 4px solid var(--primary-color);
        }
        
        .form-section-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        /* استایل‌های جدید برای پیش‌نمایش گزارش */
        .report-preview {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- صفحه احراز هویت -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-welcome">
                <h1 style="font-size: 36px; margin-bottom: 20px;">سیستم جامع مدیریت تغذیه گیاهان</h1>
                <p style="font-size: 18px; opacity: 0.9; line-height: 1.8; margin-bottom: 30px;">
                    سیستم پیشرفته محاسبه نیازهای غذایی گیاهان بر اساس استانداردهای بین‌المللی و ملی
                </p>
                <div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>محاسبات علمی دقیق</h3>
                            <p style="opacity: 0.8;">بر اساس استانداردهای FAO و مؤسسه تحقیقات خاک و آب ایران</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>مدیریت کامل فرمول‌ها</h3>
                            <p style="opacity: 0.8;">تنظیم و شخصی‌سازی تمام پارامترهای محاسباتی</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>گزارش‌های حرفه‌ای</h3>
                            <p style="opacity: 0.8;">خروجی A4 با قابلیت چاپ و ذخیره</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="auth-form-container">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">ورود به سیستم</button>
                    <button class="auth-tab" data-tab="register">ثبت‌نام</button>
                </div>
                
                <!-- فرم ورود -->
                <div id="login-form" class="auth-content active">
                    <div id="login-alert" class="alert" style="display: none;"></div>
                    
                    <div class="form-group input-with-icon">
                        <label class="form-label required">
                            <i class="fas fa-user ml-10"></i>
                            نام کاربری
                        </label>
                        <input type="text" id="login-username" class="form-control" placeholder="نام کاربری خود را وارد کنید" autocomplete="username">
                    </div>
                    
                    <div class="form-group input-with-icon password-wrapper">
                        <label class="form-label required">
                            <i class="fas fa-lock ml-10"></i>
                            رمز عبور
                        </label>
                        <input type="password" id="login-password" class="form-control" placeholder="رمز عبور خود را وارد کنید" autocomplete="current-password">
                        <button type="button" class="password-toggle" id="toggle-login-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <button id="login-btn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                    </button>
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <strong>کاربران پیش‌فرض:</strong><br>
                        مدیر: admin / Admin@2024<br>
                        کارشناس: expert / Expert@2024<br>
                        کاربر: user / User@2024
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn btn-link" id="forgot-password-btn">
                            رمز عبور را فراموش کرده‌ام
                        </button>
                    </div>
                </div>
                
                <!-- فرم ثبت‌نام -->
                <div id="register-form" class="auth-content">
                    <div id="register-alert" class="alert" style="display: none;"></div>
                    
                    <div class="form-group">
                        <label class="form-label required">نام کامل</label>
                        <input type="text" id="register-fullname" class="form-control" placeholder="نام و نام خانوادگی" autocomplete="name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">نام کاربری</label>
                        <input type="text" id="register-username" class="form-control" placeholder="حداقل 4 کاراکتر" autocomplete="username">
                        <div class="form-help">نام کاربری باید حداقل ۴ کاراکتر باشد و فقط می‌تواند شامل حروف انگلیسی و اعداد باشد</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">ایمیل</label>
                        <input type="email" id="register-email" class="form-control" placeholder="example@domain.com" autocomplete="email">
                    </div>
                    
                    <div class="form-group password-wrapper">
                        <label class="form-label required">رمز عبور</label>
                        <input type="password" id="register-password" class="form-control" placeholder="حداقل 8 کاراکتر" autocomplete="new-password">
                        <button type="button" class="password-toggle" id="toggle-register-password">
                            <i class="fas fa-eye"></i>
                        </button>
                        <div class="form-help">رمز عبور باید حداقل ۸ کاراکتر و شامل حروف بزرگ، کوچک و اعداد باشد</div>
                    </div>
                    
                    <div class="form-group password-wrapper">
                        <label class="form-label required">تکرار رمز عبور</label>
                        <input type="password" id="register-confirm-password" class="form-control" autocomplete="new-password">
                        <button type="button" class="password-toggle" id="toggle-register-confirm">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">نوع درخواست</label>
                        <select id="register-type" class="form-control">
                            <option value="user">کاربر عادی</option>
                            <option value="expert">کارشناس</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="register-terms" required>
                            با <a href="#" id="terms-link">قوانین و شرایط</a> استفاده از سیستم موافقم
                        </label>
                    </div>
                    
                    <button id="register-btn" class="btn btn-success" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-user-plus"></i> ثبت‌نام در سیستم
                    </button>
                    
                    <p style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 14px;">
                        پس از ثبت‌نام، حساب کاربری شما باید توسط مدیر سیستم تأیید شود.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- برنامه اصلی -->
    <div id="main-app" class="container" style="display: none;">
        <!-- هدر -->
        <div class="app-header">
            <div>
                <h1 style="color: var(--primary-color); margin-bottom: 5px;">سیستم جامع مدیریت تغذیه گیاهان</h1>
                <p style="color: var(--text-secondary);" id="user-info">خوش آمدید</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button id="help-btn" class="btn btn-secondary no-print">
                    <i class="fas fa-question-circle"></i> راهنما
                </button>
                <button id="print-btn" class="btn btn-secondary no-print">
                    <i class="fas fa-print"></i> چاپ
                </button>
                <button id="logout-btn" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> خروج
                </button>
            </div>
        </div>
        
        <!-- ناوبری -->
        <div class="app-nav">
            <button class="nav-btn active" data-screen="dashboard">
                <i class="fas fa-home"></i> داشبورد
            </button>
            <button class="nav-btn" data-screen="planner">
                <i class="fas fa-calculator"></i> برنامه‌ریز تغذیه
            </button>
            <button class="nav-btn" data-screen="reports">
                <i class="fas fa-chart-bar"></i> گزارش‌ها
            </button>
            <button class="nav-btn" data-screen="history">
                <i class="fas fa-history"></i> تاریخچه
            </button>
            <button class="nav-btn admin-only" data-screen="users" style="display: none;">
                <i class="fas fa-users-cog"></i> مدیریت کاربران
            </button>
            <button class="nav-btn admin-only" data-screen="prices" style="display: none;">
                <i class="fas fa-money-bill-wave"></i> مدیریت قیمت‌ها
            </button>
            <button class="nav-btn admin-only" data-screen="formulas" style="display: none;">
                <i class="fas fa-flask"></i> فرمول‌های محاسباتی
            </button>
            <button class="nav-btn admin-only" data-screen="access" style="display: none;">
                <i class="fas fa-shield-alt"></i> مدیریت دسترسی‌ها
            </button>
            <button class="nav-btn" data-screen="profile">
                <i class="fas fa-user"></i> پروفایل
            </button>
        </div>
        
        <!-- ناوبری موبایل -->
        <div class="mobile-nav">
            <button class="mobile-nav-btn active" data-screen="dashboard">
                <i class="fas fa-home"></i><br>داشبورد
            </button>
            <button class="mobile-nav-btn" data-screen="planner">
                <i class="fas fa-calculator"></i><br>برنامه‌ریز
            </button>
            <button class="mobile-nav-btn" data-screen="reports">
                <i class="fas fa-chart-bar"></i><br>گزارش‌ها
            </button>
            <button class="mobile-nav-btn" data-screen="history">
                <i class="fas fa-history"></i><br>تاریخچه
            </button>
            <button class="mobile-nav-btn" data-screen="profile">
                <i class="fas fa-user"></i><br>پروفایل
            </button>
        </div>
        
        <!-- محتوای برنامه -->
        <div class="app-content">
            <!-- داشبورد -->
            <div id="dashboard-screen" class="screen active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">کاربران فعال</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--secondary-color), #2196F3);">
                            <i class="fas fa-calculator"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-calculations">0</div>
                            <div class="stat-label">محاسبات انجام شده</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--success-color), #4CAF50);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-savings">0 ریال</div>
                            <div class="stat-label">صرفه‌جویی مالی</div>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent-color), #FFB74D);">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="active-crops">7</div>
                            <div class="stat-label">محصولات پشتیبانی شده</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="card">
                        <div class="card-header">
                            <h3>آخرین محاسبات</h3>
                            <button class="btn btn-sm btn-secondary" id="view-all-calculations">مشاهده همه</button>
                        </div>
                        <div id="recent-calculations" style="min-height: 200px;"></div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3>کاربران جدید</h3>
                            <button class="btn btn-sm btn-secondary admin-only" id="view-all-users" style="display: none;">مشاهده همه</button>
                        </div>
                        <div id="recent-users" style="min-height: 200px;"></div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>راهنما و نکات مهم</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>نکات مهم:</strong><br>
                        ۱. برای شروع محاسبه، از منوی "برنامه‌ریز تغذیه" استفاده کنید.<br>
                        ۲. گزارش‌های خود را می‌توانید در بخش "تاریخچه" مشاهده کنید.<br>
                        ۳. در صورت نیاز به کمک، روی دکمه "راهنما" کلیک کنید.<br>
                        ۴. برای تغییر اطلاعات حساب خود به بخش "پروفایل" مراجعه کنید.
                    </div>
                </div>
            </div>
            
            <!-- بقیه صفحات (همانند فایل اصلی) -->
            <!-- ... کد صفحات باقی‌مانده ... -->
        </div>
    </div>

    <!-- مودال‌های اضافی -->
    <!-- مودال راهنما -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">راهنمای سیستم</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-section">
                    <h4 class="form-section-title">نحوه کار با سیستم</h4>
                    <p>۱. ابتدا با یکی از حساب‌های کاربری موجود وارد سیستم شوید.</p>
                    <p>۲. برای محاسبه نیازهای غذایی، به بخش "برنامه‌ریز تغذیه" بروید.</p>
                    <p>۳. مراحل چهارگانه را تکمیل کنید: اطلاعات محصول، آنالیز خاک، آنالیز آب، نتایج.</p>
                    <p>۴. نتایج محاسبات را می‌توانید ذخیره، چاپ یا دانلود کنید.</p>
                </div>
                
                <div class="form-section">
                    <h4 class="form-section-title">نقش‌های کاربری</h4>
                    <p><strong>مدیر سیستم:</strong> دسترسی کامل به همه بخش‌ها</p>
                    <p><strong>کارشناس:</strong> دسترسی به محاسبات و گزارش‌ها</p>
                    <p><strong>کاربر عادی:</strong> دسترسی محدود به محاسبات پایه</p>
                </div>
                
                <div class="form-section">
                    <h4 class="form-section-title">تماس با پشتیبانی</h4>
                    <p>ایمیل: support@agri-nutrition.ir</p>
                    <p>تلفن: ۰۲۱-۱۲۳۴۵۶۷۸</p>
                </div>
            </div>
        </div>
    </div>

    <!-- مودال بازیابی رمز عبور -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">بازیابی رمز عبور</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div id="forgot-password-alert" class="alert" style="display: none;"></div>
                
                <div class="form-group">
                    <label class="form-label">ایمیل یا نام کاربری</label>
                    <input type="text" id="forgot-email" class="form-control" placeholder="ایمیل یا نام کاربری خود را وارد کنید">
                </div>
                
                <button id="reset-password-btn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-key"></i> ارسال لینک بازیابی
                </button>
                
                <p style="text-align: center; margin-top: 20px; color: var(--text-secondary); font-size: 14px;">
                    لینک بازیابی رمز عبور به ایمیل شما ارسال خواهد شد.
                </p>
            </div>
        </div>
    </div>

    <!-- مودال تاییدیه -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <div class="confirmation-modal">
                <h3 id="confirmation-title" style="margin-bottom: 20px; text-align: center;"></h3>
                <p id="confirmation-message" style="margin-bottom: 30px; text-align: center;"></p>
                
                <div style="display: flex; justify-content: center; gap: 15px;">
                    <button id="confirm-yes" class="btn btn-primary">بله</button>
                    <button id="confirm-no" class="btn btn-secondary">خیر</button>
                </div>
            </div>
        </div>
    </div>

    <!-- اسکریپت‌های اصلاح شده -->
    <script>
        // ==================== سیستم جامع مدیریت تغذیه گیاهان ====================
        
        class NutritionManagementSystem {
            constructor() {
                this.currentUser = null;
                this.users = {};
                this.prices = {};
                this.calculations = [];
                this.formulas = {};
                this.currentCalculation = null;
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.confirmationCallback = null;
                this.initialize();
            }
            
            initialize() {
                // بررسی پشتیبانی مرورگر
                if (!this.checkBrowserSupport()) {
                    this.showBrowserWarning();
                    return;
                }
                
                this.loadData();
                this.setupEventListeners();
                this.setupPlannerInputs();
                this.checkExpiredAccounts();
                this.loadFormulas();
                
                // فعالسازی رویدادهای کلیدهای کیبورد
                this.setupKeyboardEvents();
                
                // تنظیم تاریخ شمسی
                this.setupPersianDate();
            }
            
            checkBrowserSupport() {
                // بررسی localStorage
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                } catch (e) {
                    console.error('localStorage پشتیبانی نمی‌شود:', e);
                    return false;
                }
                
                // بررسی ES6 features
                try {
                    new Function('() => {}');
                } catch (e) {
                    console.error('ES6 پشتیبانی نمی‌شود:', e);
                    return false;
                }
                
                return true;
            }
            
            showBrowserWarning() {
                const warning = `
                    <div class="error-boundary">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: var(--warning-color); margin-bottom: 20px;"></i>
                        <h3>مرورگر شما قدیمی است!</h3>
                        <p>برای استفاده از سیستم، لطفاً مرورگر خود را به آخرین نسخه بروزرسانی کنید.</p>
                        <p>مرورگرهای پشتیبانی شده: Chrome 60+, Firefox 55+, Safari 11+, Edge 79+</p>
                        <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> بارگذاری مجدد
                        </button>
                    </div>
                `;
                
                document.body.innerHTML = warning;
            }
            
            loadData() {
                try {
                    // بارگذاری کاربران
                    const usersData = localStorage.getItem('nutrition_users');
                    if (usersData) {
                        this.users = JSON.parse(usersData);
                    } else {
                        this.createDefaultUsers();
                    }
                    
                    // بارگذاری قیمت‌ها
                    const pricesData = localStorage.getItem('nutrition_prices');
                    if (pricesData) {
                        this.prices = JSON.parse(pricesData);
                    } else {
                        this.createDefaultPrices();
                    }
                    
                    // بارگذاری محاسبات
                    const calculationsData = localStorage.getItem('nutrition_calculations');
                    if (calculationsData) {
                        this.calculations = JSON.parse(calculationsData);
                    }
                    
                    // بارگذاری فرمول‌ها
                    const formulasData = localStorage.getItem('nutrition_formulas');
                    if (formulasData) {
                        this.formulas = JSON.parse(formulasData);
                    } else {
                        this.createDefaultFormulas();
                    }
                    
                    // بارگذاری کاربر جاری
                    const currentUserData = localStorage.getItem('currentUser');
                    if (currentUserData) {
                        this.currentUser = JSON.parse(currentUserData);
                        this.showMainApp();
                    }
                } catch (error) {
                    console.error('خطا در بارگذاری داده‌ها:', error);
                    this.showAlert('خطا در بارگذاری داده‌های ذخیره شده. لطفاً صفحه را مجدداً بارگذاری کنید.', 'error');
                }
            }
            
            createDefaultUsers() {
                // استفاده از الگوریتم SHA-256 برای هش رمز عبور
                const hashPassword = async (password) => {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(password);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                };
                
                // ایجاد کاربران پیش‌فرض
                this.users = {
                    'admin': {
                        username: 'admin',
                        password: this.hashPassword('Admin@2024'),
                        fullName: 'مدیر سیستم',
                        email: 'admin@system.com',
                        phone: '09123456789',
                        role: 'admin',
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: null,
                        lastLogin: null,
                        permissions: {
                            crops: ['all'],
                            sections: ['all'],
                            reports: ['all']
                        },
                        loginLogs: []
                    },
                    'expert': {
                        username: 'expert',
                        password: this.hashPassword('Expert@2024'),
                        fullName: 'کارشناس کشاورزی',
                        email: 'expert@system.com',
                        phone: '09129876543',
                        role: 'expert',
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: null,
                        lastLogin: null,
                        permissions: {
                            crops: ['wheat', 'rice', 'saffron', 'cucumber', 'tomato'],
                            sections: ['dashboard', 'planner', 'reports', 'history'],
                            reports: ['basic', 'detailed']
                        },
                        loginLogs: []
                    },
                    'user': {
                        username: 'user',
                        password: this.hashPassword('User@2024'),
                        fullName: 'کاربر نمونه',
                        email: 'user@system.com',
                        phone: '09121234567',
                        role: 'user',
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: this.addDays(new Date(), 30).toISOString(),
                        lastLogin: null,
                        permissions: {
                            crops: ['wheat', 'saffron'],
                            sections: ['dashboard', 'planner', 'history'],
                            reports: ['basic']
                        },
                        loginLogs: []
                    }
                };
                
                this.saveUsers();
            }
            
            // ادامه کلاس و توابع...
            
            setupKeyboardEvents() {
                $(document).on('keypress', (e) => {
                    // Enter key
                    if (e.key === 'Enter' || e.keyCode === 13) {
                        if ($('#auth-screen').is(':visible')) {
                            if ($('#login-form').is(':visible')) {
                                $('#login-btn').click();
                            } else if ($('#register-form').is(':visible')) {
                                $('#register-btn').click();
                            }
                        }
                    }
                    
                    // Escape key
                    if (e.key === 'Escape' || e.keyCode === 27) {
                        $('.modal.active .modal-close').click();
                    }
                });
            }
            
            setupPersianDate() {
                // تنظیم تاریخ فارسی در گزارش‌ها
                const persianMonths = [
                    'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
                    'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
                ];
                
                Date.prototype.toPersianDate = function() {
                    const date = new Date(this);
                    const persianDate = date.toLocaleDateString('fa-IR');
                    return persianDate;
                };
            }
            
            // توابع بهبود یافته برای نمایش هشدارها
            showAlert(message, type = 'info', duration = 5000) {
                const alertId = 'alert-' + Date.now();
                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type}" style="animation: fadeIn 0.3s;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                        type === 'error' ? 'exclamation-circle' : 
                                        type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                    </div>
                `;
                
                // اضافه کردن هشدار به صفحه
                $('#alerts-container').append(alertHtml);
                
                // حذف خودکار هشدار
                setTimeout(() => {
                    $(`#${alertId}`).fadeOut(300, function() {
                        $(this).remove();
                    });
                }, duration);
            }
            
            // تابع بهبود یافته برای هش کردن رمز عبور
            hashPassword(password) {
                // استفاده از SHA-256
                return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
            }
            
            // تابع بهبود یافته برای ذخیره داده‌ها
            async saveData() {
                try {
                    await this.saveUsers();
                    await this.savePrices();
                    await this.saveFormulas();
                    await this.saveCalculations();
                    return true;
                } catch (error) {
                    console.error('خطا در ذخیره داده‌ها:', error);
                    this.showAlert('خطا در ذخیره داده‌ها. لطفاً دوباره امتحان کنید.', 'error');
                    return false;
                }
            }
            
            // تابع بهبود یافته برای نمایش تاییدیه
            showConfirmation(title, message, callback) {
                $('#confirmation-title').text(title);
                $('#confirmation-message').text(message);
                this.confirmationCallback = callback;
                $('#confirmation-modal').addClass('active');
            }
            
            // تابع بهبود یافته برای تولید PDF
            generatePDF(elementId, filename = 'report.pdf') {
                const { jsPDF } = window.jspdf;
                const element = document.getElementById(elementId);
                
                html2canvas(element).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 190;
                    const pageHeight = 295;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(filename);
                    this.showAlert('گزارش با موفقیت دانلود شد', 'success');
                });
            }
            
            // ادامه توابع...
        }

        // راه‌اندازی سیستم
        $(document).ready(function() {
            // بررسی وجود CryptoJS برای هش کردن
            if (typeof CryptoJS === 'undefined') {
                console.error('CryptoJS بارگذاری نشده است!');
                // بارگذاری CryptoJS
                $.getScript('https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js', function() {
                    window.system = new NutritionManagementSystem();
                });
            } else {
                window.system = new NutritionManagementSystem();
            }
            
            // مدیریت رویدادهای کلیک
            $(document).on('click', function(e) {
                // بستن مودال با کلیک بیرون
                if ($(e.target).hasClass('modal')) {
                    $(e.target).removeClass('active');
                }
            });
            
            // مدیریت نمایش/مخفی کردن رمز عبور
            $(document).on('click', '.password-toggle', function() {
                const input = $(this).siblings('input');
                const icon = $(this).find('i');
                
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
            
            // مدیریت رویدادهای تأییدیه
            $('#confirm-yes').click(function() {
                if (window.system.confirmationCallback) {
                    window.system.confirmationCallback(true);
                }
                $('#confirmation-modal').removeClass('active');
            });
            
            $('#confirm-no').click(function() {
                if (window.system.confirmationCallback) {
                    window.system.confirmationCallback(false);
                }
                $('#confirmation-modal').removeClass('active');
            });
            
            // مدیریت رویداد راهنما
            $('#help-btn').click(function() {
                $('#help-modal').addClass('active');
            });
            
            // مدیریت رویداد بازیابی رمز عبور
            $('#forgot-password-btn').click(function() {
                $('#forgot-password-modal').addClass('active');
            });
            
            // مدیریت دکمه مشاهده همه
            $('#view-all-calculations').click(function() {
                window.system.showScreen('history');
            });
            
            $('#view-all-users').click(function() {
                window.system.showScreen('users');
            });
            
            // مدیریت ناوبری موبایل
            $(document).on('click', '.mobile-nav-btn', function() {
                const screen = $(this).data('screen');
                $('.mobile-nav-btn').removeClass('active');
                $(this).addClass('active');
                window.system.showScreen(screen);
            });
            
            // مدیریت رویداد تغییر اندازه پنجره
            $(window).resize(function() {
                if ($(window).width() <= 768) {
                    $('.app-nav').hide();
                } else {
                    $('.app-nav').show();
                }
            });
        });
    </script>
    
    <!-- اسکریپت CryptoJS برای هش کردن ایمن -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- اسکریپت برای مدیریت بهتر تاریخ -->
    <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css">
    
    <script>
        // کد اضافی برای مدیریت بهتر تاریخ‌ها
        $(document).ready(function() {
            // تبدیل تاریخ‌های میلادی به شمسی
            $('.persian-date').each(function() {
                const gregorianDate = new Date($(this).text());
                const persianDate = new PersianDate(gregorianDate).format('YYYY/MM/DD');
                $(this).text(persianDate);
            });
            
            // فعال‌سازی datepicker فارسی
            $('.date-picker').persianDatepicker({
                format: 'YYYY/MM/DD',
                autoClose: true,
                initialValue: false,
                persianDigit: true,
                toolbox: {
                    calendarSwitch: {
                        enabled: true
                    }
                }
            });
        });
    </script>
</body>
</html>
