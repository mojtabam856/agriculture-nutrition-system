<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم جامع مدیریت تغذیه گیاهان</title>
    
    <!-- فونت Vazir از CDN ایرانی -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v33.0.2/dist/font-face.css">
    
    <!-- jQuery از CDN جایگزین -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CryptoJS برای هش کردن -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <!-- jsPDF و html2canvas -->
    <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* استایل‌های پایه */
        :root {
            --primary-color: #1a5f23;
            --primary-light: #2e8b32;
            --primary-dark: #0d4513;
            --secondary-color: #1565C0;
            --accent-color: #FF9800;
            --error-color: #C62828;
            --warning-color: #F57C00;
            --success-color: #388E3C;
            --info-color: #0288D1;
            --background-color: #F5F7FA;
            --card-color: #FFFFFF;
            --text-primary: #2C3E50;
            --text-secondary: #546E7A;
            --border-color: #E0E0E0;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --box-shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazir', Tahoma, 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--text-primary);
            line-height: 1.7;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* اگر فونت Vazir لود نشد، از فونت سیستمی استفاده کن */
        .vazir-fallback {
            font-family: Tahoma, 'Segoe UI', sans-serif !important;
        }
        
        /* بقیه استایل‌ها... */
        /* [همه استایل‌های قبلی شما اینجا باقی می‌مانند] */
        
    </style>
</head>
<body>
    <!-- صفحه احراز هویت -->
    <div id="auth-screen">
        <div class="auth-container">
            <div class="auth-welcome">
                <h1 style="font-size: 36px; margin-bottom: 20px;">سیستم جامع مدیریت تغذیه گیاهان</h1>
                <p style="font-size: 18px; opacity: 0.9; line-height: 1.8; margin-bottom: 30px;">
                    سیستم پیشرفته محاسبه نیازهای غذایی گیاهان بر اساس استانداردهای بین‌المللی و ملی
                </p>
                <div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>محاسبات علمی دقیق</h3>
                            <p style="opacity: 0.8;">بر اساس استانداردهای FAO و مؤسسه تحقیقات خاک و آب ایران</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>مدیریت کامل فرمول‌ها</h3>
                            <p style="opacity: 0.8;">تنظیم و شخصی‌سازی تمام پارامترهای محاسباتی</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-check-circle" style="font-size: 24px; margin-left: 15px;"></i>
                        <div>
                            <h3>گزارش‌های حرفه‌ای</h3>
                            <p style="opacity: 0.8;">خروجی A4 با قابلیت چاپ و ذخیره</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="auth-form-container">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">ورود به سیستم</button>
                    <button class="auth-tab" data-tab="register">ثبت‌نام</button>
                </div>
                
                <!-- فرم ورود -->
                <div id="login-form" class="auth-content active">
                    <div id="login-alert" class="alert" style="display: none;"></div>
                    
                    <div class="form-group input-with-icon">
                        <label class="form-label required">
                            <i class="fas fa-user ml-10"></i>
                            نام کاربری
                        </label>
                        <input type="text" id="login-username" class="form-control" placeholder="نام کاربری خود را وارد کنید" autocomplete="username">
                    </div>
                    
                    <div class="form-group input-with-icon password-wrapper">
                        <label class="form-label required">
                            <i class="fas fa-lock ml-10"></i>
                            رمز عبور
                        </label>
                        <input type="password" id="login-password" class="form-control" placeholder="رمز عبور خود را وارد کنید" autocomplete="current-password">
                        <button type="button" class="password-toggle" id="toggle-login-password">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <button id="login-btn" class="btn btn-primary" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-sign-in-alt"></i> ورود به سیستم
                    </button>
                    
                    <!-- این بخش حذف شده: نمایش نام کاربری‌ها -->
                    <!-- <div class="alert alert-info" style="margin-top: 20px;">...</div> -->
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn btn-link" id="forgot-password-btn">
                            رمز عبور را فراموش کرده‌ام
                        </button>
                    </div>
                </div>
                
                <!-- بقیه کدهای شما بدون تغییر باقی می‌مانند -->
                <!-- ... -->
                
    <!-- اسکریپت‌های اصلاح شده -->
    <script>
        // ==================== سیستم جامع مدیریت تغذیه گیاهان ====================
        
        class NutritionManagementSystem {
            constructor() {
                this.currentUser = null;
                this.users = {};
                this.prices = {};
                this.calculations = [];
                this.formulas = {};
                this.currentCalculation = null;
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.confirmationCallback = null;
                
                // کاربران پیش‌فرض (داده‌های خصوصی)
                this.DEFAULT_USERS = {
                    'admin': { password: 'Admin@2024', role: 'admin' },
                    'expert': { password: 'Expert@2024', role: 'expert' },
                    'user': { password: 'User@2024', role: 'user' }
                };
                
                this.initialize();
            }
            
            initialize() {
                // بررسی CDNها
                this.checkCDNs();
                
                // بارگذاری داده‌ها
                this.loadData();
                this.setupEventListeners();
                this.setupPlannerInputs();
                this.checkExpiredAccounts();
                this.loadFormulas();
                
                // تنظیم رویدادها
                this.setupKeyboardEvents();
            }
            
            checkCDNs() {
                // بررسی فونت Vazir
                setTimeout(() => {
                    const testSpan = document.createElement('span');
                    testSpan.style.fontFamily = 'Vazir';
                    testSpan.style.position = 'absolute';
                    testSpan.style.opacity = '0';
                    testSpan.textContent = 'تست فونت';
                    document.body.appendChild(testSpan);
                    
                    if (testSpan.offsetWidth === 0) {
                        console.warn('فونت Vazir لود نشد. استفاده از فونت سیستمی.');
                        document.body.classList.add('vazir-fallback');
                    }
                    
                    document.body.removeChild(testSpan);
                }, 1000);
                
                // بررسی jQuery
                if (typeof jQuery === 'undefined') {
                    console.error('jQuery لود نشد!');
                    this.loadjQueryFallback();
                }
                
                // بررسی CryptoJS
                if (typeof CryptoJS === 'undefined') {
                    console.error('CryptoJS لود نشد!');
                    this.loadCryptoJSFallback();
                }
            }
            
            loadjQueryFallback() {
                const script = document.createElement('script');
                script.src = 'https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js';
                script.onload = () => {
                    console.log('jQuery از fallback لود شد');
                    this.setupEventListeners();
                };
                document.head.appendChild(script);
            }
            
            loadCryptoJSFallback() {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js';
                script.onload = () => console.log('CryptoJS از fallback لود شد');
                document.head.appendChild(script);
            }
            
            loadData() {
                try {
                    // بارگذاری از localStorage
                    const usersData = localStorage.getItem('nutrition_users');
                    if (usersData) {
                        this.users = JSON.parse(usersData);
                    } else {
                        this.createDefaultUsers();
                    }
                    
                    const calculationsData = localStorage.getItem('nutrition_calculations');
                    if (calculationsData) {
                        this.calculations = JSON.parse(calculationsData);
                    }
                    
                    const formulasData = localStorage.getItem('nutrition_formulas');
                    if (formulasData) {
                        this.formulas = JSON.parse(formulasData);
                    } else {
                        this.createDefaultFormulas();
                    }
                    
                    // بارگذاری کاربر جاری
                    const currentUserData = localStorage.getItem('currentUser');
                    if (currentUserData) {
                        this.currentUser = JSON.parse(currentUserData);
                        this.showMainApp();
                    }
                } catch (error) {
                    console.error('خطا در بارگذاری داده‌ها:', error);
                }
            }
            
            createDefaultUsers() {
                // هش کردن رمزهای عبور
                Object.keys(this.DEFAULT_USERS).forEach(username => {
                    const userData = this.DEFAULT_USERS[username];
                    this.users[username] = {
                        username: username,
                        password: this.hashPassword(userData.password),
                        fullName: this.getUserFullName(username),
                        email: `${username}@system.com`,
                        phone: '09120000000',
                        role: userData.role,
                        status: 'active',
                        registrationDate: new Date().toISOString(),
                        expiryDate: null,
                        permissions: this.getDefaultPermissions(userData.role),
                        loginLogs: []
                    };
                });
                
                this.saveUsers();
            }
            
            getUserFullName(username) {
                const names = {
                    'admin': 'مدیر سیستم',
                    'expert': 'کارشناس کشاورزی',
                    'user': 'کاربر نمونه'
                };
                return names[username] || username;
            }
            
            getDefaultPermissions(role) {
                switch(role) {
                    case 'admin':
                        return { crops: ['all'], sections: ['all'], reports: ['all'] };
                    case 'expert':
                        return { 
                            crops: ['wheat', 'rice', 'saffron', 'cucumber', 'tomato'],
                            sections: ['dashboard', 'planner', 'reports', 'history'],
                            reports: ['basic', 'detailed']
                        };
                    case 'user':
                        return { 
                            crops: ['wheat', 'saffron'],
                            sections: ['dashboard', 'planner', 'history'],
                            reports: ['basic']
                        };
                    default:
                        return { crops: [], sections: [], reports: [] };
                }
            }
            
            hashPassword(password) {
                // استفاده از SHA-256
                if (typeof CryptoJS !== 'undefined') {
                    return CryptoJS.SHA256(password).toString(CryptoJS.enc.Hex);
                }
                // fallback ساده اگر CryptoJS لود نشد
                return btoa(password);
            }
            
            // بقیه توابع کلاس...
            
            setupEventListeners() {
                // رویدادهای ورود
                $('#login-btn').on('click', () => this.handleLogin());
                $('#register-btn').on('click', () => this.handleRegister());
                
                // Enter برای ورود
                $(document).on('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if ($('#login-form').is(':visible')) {
                            $('#login-btn').click();
                        } else if ($('#register-form').is(':visible')) {
                            $('#register-btn').click();
                        }
                    }
                });
                
                // نمایش/مخفی کردن رمز عبور
                $(document).on('click', '.password-toggle', function() {
                    const input = $(this).siblings('input');
                    const icon = $(this).find('i');
                    
                    if (input.attr('type') === 'password') {
                        input.attr('type', 'text');
                        icon.removeClass('fa-eye').addClass('fa-eye-slash');
                    } else {
                        input.attr('type', 'password');
                        icon.removeClass('fa-eye-slash').addClass('fa-eye');
                    }
                });
                
                // خروج
                $('#logout-btn').on('click', () => this.handleLogout());
            }
            
            handleLogin() {
                const username = $('#login-username').val().trim();
                const password = $('#login-password').val();
                
                if (!username || !password) {
                    this.showAlert('لطفا نام کاربری و رمز عبور را وارد کنید', 'error', 'login-alert');
                    return;
                }
                
                const user = this.users[username];
                
                // بررسی کاربر پیش‌فرض
                if (!user && this.DEFAULT_USERS[username]) {
                    if (password === this.DEFAULT_USERS[username].password) {
                        // اولین ورود - ایجاد کاربر
                        this.createDefaultUser(username);
                        this.showAlert('ورود موفق! کاربر جدید ایجاد شد.', 'success', 'login-alert');
                        setTimeout(() => this.handleLogin(), 1000);
                        return;
                    }
                }
                
                if (!user || user.password !== this.hashPassword(password)) {
                    this.showAlert('نام کاربری یا رمز عبور اشتباه است', 'error', 'login-alert');
                    return;
                }
                
                if (user.status !== 'active') {
                    this.showAlert('حساب کاربری شما غیرفعال است', 'error', 'login-alert');
                    return;
                }
                
                // ورود موفق
                this.currentUser = {
                    username: user.username,
                    fullName: user.fullName,
                    role: user.role,
                    permissions: user.permissions
                };
                
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                
                this.showAlert('ورود موفقیت‌آمیز! در حال انتقال...', 'success', 'login-alert');
                setTimeout(() => this.showMainApp(), 1500);
            }
            
            createDefaultUser(username) {
                const userData = this.DEFAULT_USERS[username];
                this.users[username] = {
                    username: username,
                    password: this.hashPassword(userData.password),
                    fullName: this.getUserFullName(username),
                    email: `${username}@system.com`,
                    role: userData.role,
                    status: 'active',
                    registrationDate: new Date().toISOString(),
                    expiryDate: null,
                    permissions: this.getDefaultPermissions(userData.role),
                    loginLogs: []
                };
                
                this.saveUsers();
            }
            
            showMainApp() {
                $('#auth-screen').hide();
                $('#main-app').show();
                this.updateUserInfo();
                this.loadDashboard();
                this.checkPermissions();
            }
            
            // بقیه توابع...
            
            showAlert(message, type = 'info', elementId = null) {
                const alertDiv = $('<div>').addClass(`alert alert-${type}`).html(`
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                    type === 'error' ? 'exclamation-circle' : 
                                    type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    ${message}
                `);
                
                if (elementId) {
                    $(`#${elementId}`).html(alertDiv).show();
                } else {
                    $('.app-content').prepend(alertDiv);
                }
                
                setTimeout(() => alertDiv.fadeOut(300, () => alertDiv.remove()), 5000);
            }
            
            saveUsers() {
                localStorage.setItem('nutrition_users', JSON.stringify(this.users));
            }
        }

        // راه‌اندازی سیستم
        $(document).ready(function() {
            window.system = new NutritionManagementSystem();
        });
    </script>
</body>
</html>
